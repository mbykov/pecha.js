!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=28)}([function(e,t){e.exports=require("electron")},function(e,t){e.exports=require("lodash")},function(e,t,n){"use strict";n.d(t,"b",function(){return o}),n.d(t,"a",function(){return r});const o={tsek:"་"},r=["འི","ར","འོ","འམ","འི","ས","འང"]},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("speckled-band")},function(e){e.exports={name:"development",description:"Add here any environment specific stuff you like."}},function(e,t){e.exports=require("electron-settings")},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=require("electron-is-dev")},,function(e,t){e.exports=require("mississippi")},function(e,t){e.exports=require("fast-csv")},function(e,t){e.exports=require("pouchdb")},function(e,t){e.exports=require("stream")},function(e,t){e.exports=require("pouchdb-load")},,,function(e,t){e.exports=require("url")},,function(e,t){e.exports=require("glob-stream")},function(e,t){e.exports=require("multistream")},function(e,t){e.exports=require("debug")},function(e,t){e.exports=require("csv2")},function(e,t){e.exports=require("node-couchdb")},function(e){e.exports={name:"pecha.js",version:"0.8.27",productName:"Pecha.js",description:"Simple practical Tibetan text analyzer",author:"Michael Bykov <m.bykov@gmail.com>",copyright:"© 2018-2019, Michael Bykov",license:"GPL-3.0",homepage:"http://diglossa.org/tibetan",main:"app/background.js",build:{appId:"org.diglossa.tibetan",files:["app/**/*","src/**/*","resources/**/*","node_modules/**/*","package.json"],directories:{buildResources:"resources"},dmg:{title:"${productName}-Setup",window:{height:380,width:540}},mac:{category:"public.app-category.productivity",icon:"resources/icon.icns"},win:{icon:"resources/icon.ico",publisherName:"Michael Bykov",publish:["github"]},linux:{category:"Educational software",target:[{target:"deb",arch:["x64"]},{target:"rpm",arch:["x64"]}],icon:"resources/icons"},publish:"github"},scripts:{postinstall:"electron-builder install-app-deps",preunit:"webpack --config=build/webpack.unit.config.js --env=test --display=none",unit:"electron-mocha temp/specs.js --renderer --require source-map-support/register",pree2e:"webpack --config=build/webpack.app.config.js --env=test --display=none && webpack --config=build/webpack.e2e.config.js --env=test --display=none",e2e:"mocha temp/e2e.js --require source-map-support/register",test:"npm run unit && npm run e2e",start:"node build/start.js",release:"webpack --config=build/webpack.app.config.js --env=production && electron-builder",release_:"npm test && webpack --config=build/webpack.app.config.js --env=production && electron-builder"},dependencies:{axios:"^0.18.0",cholok:"^0.2.0",csv2:"^0.1.1",debug:"^4.1.1","electron-clipboard-extended":"^1.1.1","electron-is-dev":"^1.0.1","electron-settings":"^3.2.0","fast-csv":"^2.4.1","file-loader":"^2.0.0","fs-extra":"^7.0.1","fs-jetpack":"^2.2.2","git-clone":"^0.1.0",glob:"^7.1.3","glob-stream":"^6.1.0",json5:"^2.1.0",lodash:"^4.17.11",memorystream:"^0.3.1",mississippi:"^3.0.0",mousetrap:"^1.6.2",multistream:"^2.1.1","node-couchdb":"^1.3.0",pouchdb:"^7.0.0","pouchdb-load":"^1.4.6",slash:"^2.0.0","speckled-band":"^2.0.0","split.js":"^1.4.0"},devDependencies:{"@babel/core":"^7.1.2","@babel/preset-env":"^7.1.0","babel-loader":"^8.0.4","babel-plugin-transform-object-rest-spread":"^7.0.0-beta.3",chai:"^4.2.0","css-loader":"^0.28.7",electron:"4.0.0","electron-builder":"^20.31.3","electron-mocha":"^6.0.4","friendly-errors-webpack-plugin":"^1.7.0",mocha:"^5.2.0","source-map-support":"^0.5.9",spectron:"^4.0.0","style-loader":"^0.23.0",webpack:"^4.20.2","webpack-cli":"^3.1.2","webpack-merge":"^4.1.4","webpack-node-externals":"^1.7.2"},repository:{type:"git",url:"git+https://github.com/mbykov/pecha.js.git"},bugs:{url:"https://github.com/mbykov/pecha.js/issues"}}},,,,function(e,t,n){"use strict";n.r(t);var o=n(1),r=n.n(o),c=n(3),i=n.n(c),s=n(17),l=n.n(s),a=n(0);const u={label:"File",submenu:[{label:"Home",accelerator:"CmdOrCtrl+L",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","home")}},{label:"Quit",accelerator:"CmdOrCtrl+Q",click:()=>{a.app.quit()}}]},p={label:"About",submenu:[{label:"About Pecha.js",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","about")}},{label:"Code and Download",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","code")}},{label:"License",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","license")}},{label:"Contacts",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","contacts")}},{label:"Acknowledgements",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","acknowledgements")}}]},d={label:"Dict",submenu:[{label:"Clone dicts from server",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","remotedicts")}},{label:"Import form CSV",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","csv")}},{label:"Arrange local dicts",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","activedicts")}},{label:"Create CSV from texts",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","localdict")}},{label:"Publish new dictionary (disabled)",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","publish")}},{label:"Cleanup DBs completely",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","cleanup")}}]},f={label:"Help",submenu:[{label:"hot keys",click:()=>{a.BrowserWindow.getFocusedWindow().webContents.send("section","help")}},{label:"Toggle DevTools",accelerator:"Alt+CmdOrCtrl+I",click:()=>{a.BrowserWindow.getFocusedWindow().toggleDevTools()}}]};var h=n(4),g=n.n(h),m=n(2);console.log;const b=m.b.tsek;const w=console.log,y=n(7),v=n(10),k=n(11),j=n(3),x=n(12),E=n(13);let R=new RegExp("་$");const C=n(1),W=console.log,D=n(7),S=n(10),B=(n(11),n(3)),q=n(13),M=n(19);n(20);let _="tib";const F=m.b.tsek;let P=new RegExp(F+"$");function O(e){let t=M(["**/*","!**/*localDict.*"],{cwd:e,nodir:!0});const n=S.through.obj((e,t,n)=>{(function(e){return D.readFile(e,"utf8").then(function(e){if(!e)return;let t=[],n={},o=e.trim().split("\n");return(o=C.compact(o)).forEach((e,o)=>{let r=function(e){let t=e.trim();return t=t.trim().replace(/\.$/,"")}(e),c=g()(r,_);c&&c.forEach(e=>{e.forEach(e=>{if(e.lang!=_)return;let o=e.text.split(" ");o.forEach(e=>{e=e.replace(P,""),n[e]||(t.push(e),n[e]=!0)})})})}),t}).catch(function(e){W("selectTib-ERR",e)})})(e.path).then(function(e){e&&(e.length?n(null,e):n())}).catch(function(e){W("WFS-ERR",e)})});let o=new q.Readable({objectMode:!0});o._read=(()=>{}),o.push("fill in second column with your translation:");let r=new q.Readable({objectMode:!0});r._read=(()=>{}),r.push("unprocessed wordforms:");const c=S.through.obj((e,t,n)=>{e.forEach(e=>{(function e(t){return Y(t).then(function(n){n.chain?n.chain.forEach(n=>{if(n.docs.length)o.push(n.seg);else{if(t.str!=n.seg)return e({str:n.seg});r.push(n.seg)}}):r.push(t.str)})})({str:e}).catch(function(e){console.log("Q-ERR",e)})}),n()}),i=S.through.obj((e,t,n)=>{n(null,JSON.stringify(e)+", -\n")}),s=S.through.obj((e,t,n)=>{n(null,JSON.stringify(e)+", -\n")});let l=B.resolve(e,"localDict.csv"),a=D.createWriteStream(l),u=B.resolve(e,"localDict.unproc"),p=D.createWriteStream(u);return t.pipe(n).pipe(c),o.pipe(i).pipe(a),r.pipe(s).pipe(p),Promise.resolve()}const T=m.b.tsek;new RegExp(T+"$");const A=n(3),N=n(7),$=(n(8),n(6));let I=n(12);n(14);I.plugin(n(14));const J=console.log;n(21),n(22);let V=[],L="ཀ",z="￰";const G=n(23),Q=(new G,new G({host:"diglossa.org",protocol:"http",port:5984,auth:{user:"guest",pass:"guest"}}));function H(e){}function U(){J("onSyncError")}function K(e){let t=$.get("cfg");if(t)!function(e){let t=$.get("upath");e.forEach((e,n)=>{if(!e.active)return;let o=A.resolve(t,"pouch",e.dname),r=new I(o);r.dname=e.dname,r.weight=n,V.push(r)}),V.map(e=>e.dname)}(t);else{t=[],$.set("cfg",t);let n=A.resolve(e,"pouch");N.ensureDirSync(n)}}function X(e){$.get("upath");let t=$.get("cfg");if(r.a.find(t,t=>t.dname==e))return t;let n={dname:e,active:!0,idx:t.length};return t.push(n),$.set("cfg",t),t}function Y(e){let t,n=function(e){let t=e.split(b),n=t.length>25?3:5,o=e,c=(t.length,[[t]]);!function e(t,i){(function(e){let t,n,o=[];for(let r=1;r<e.length+1;r++){t=e.slice(0,r),n=e.slice(r);let c={head:t,tail:n};n.length&&o.push(c)}return o.reverse()})(t).forEach(t=>{i.push(t.head),i.push(t.tail),r.a.flatten(i).join(b)==o&&(c.push(r.a.clone(i)),i.pop()),i.length<n&&e(t.tail,i),i.pop()})}(t,[]);let i=[];return c.forEach(e=>{let t=[];e.forEach(e=>{t.push(e.join(b))}),i.push(t)}),i}(e.str),o=function(e){let t=r.a.uniq(r.a.flatten(e)),n=[];return t.forEach(e=>{m.a.forEach(t=>{let o=new RegExp(t+"$"),r=e.replace(o,"");e!=r&&n.push(r)})}),{main:t,added:n}}(n);t=e.compound?r.a.filter(o.main,t=>t!=e.str):r.a.uniq(o.main.concat(o.added));V.map(e=>e.dname);return Promise.all(V.map(function(e){return e.allDocs({keys:t,include_docs:!0}).then(function(t){if(!t||!t.rows)throw new Error("no dbn result");let n=r.a.compact(t.rows.map(e=>e.doc)),o=r.a.flatten(r.a.compact(n.map(e=>e.docs)));return o.forEach(t=>{t.dname=e.dname,t.weight=e.weight}),o}).catch(function(e){console.log("ERR GET DBs",e)})})).then(function(t){let o=function(e,t){let n,o=function(e,t){let n=[],o=[];e.forEach(e=>{let c=[],i=!1,s=!0;e.forEach(e=>{let n=r.a.filter(t,t=>(function(e,t){if(e==t)return!0;let n=new RegExp("^"+t),o=e.replace(n,"");return!(e==o||!m.a.includes(o))})(e,t.dict));n.length&&(i=!0),n.length||(s=!1);let o={seg:e,docs:n};c.push(o)}),i&&n.push(c),s&&o.push(c)}),o.length&&(n=o);return function(e){let t=r.a.max(e.map(e=>r.a.sum(e.map(e=>e.docs.length?e.seg.length:0))/e.length)),n=r.a.filter(e,e=>r.a.sum(e.map(e=>e.docs.length?e.seg.length:0))/e.length>=t-1),o=r.a.min(n.map(e=>e.length));return r.a.filter(n,e=>e.length==o)}(n)}(t,e);o.length>1?n=function(e){let t,n=e[0],o=[];for(let c=0;c<n.length;c++){let i=e.map(e=>e[c].seg);if(1==r.a.uniq(i).length)o.push(n[c]),t=null;else{t||(t={ambi:!0,seg:"",docs:[]},o.push(t));let n=e.map(e=>({seg:e[c].seg,docs:e[c].docs}));t.docs.push(n)}}return r.a.filter(o,e=>e.ambi).forEach(e=>{let t=e.docs[0],n=[];for(let o=0;o<t.length;o++){let t=e.docs.map(e=>e[o]);n.push(t)}e.chains=n;let o=n[0];e.seg=o.map(e=>e.seg).join(T)}),o}(o):1==o.length&&(n=o[0]);return n}(r.a.flatten(t),n);return e.chain=o,e})}function Z(e,t){let n,o;N.readJson(e).then(function(r){let c=$.get("upath");return n=r.name,o=A.resolve(c,"pouch",n),function(e,t){let n=y.readJsonSync(e);n._id="description";let o=j.parse(e).dir,r=j.resolve(o,n.path);if(w("csvpath",r),w("csvpath",y.pathExistsSync(r)),!y.pathExistsSync(r))return"";let c=y.createReadStream(r),i=k({comment:"#",trim:!0,ignoreEmpty:!0}).on("end",function(){}).on("error",function(e){w("CSV STEREAM ERR",e)});const s=v.through.obj(function(e,t,n){let o=e[0].replace(R,"");n(null,{_id:o,docs:[{dict:o,trns:e.slice(1).join("").trim().split("; ")}]})});y.emptyDirSync(t);let l=new x(t),a=[],u=new class extends E.Writable{constructor(e){super(e),this.buff=[]}_write(e,t,n){a.length<1e3?(a.push(e),n()):(a.push(e),l.bulkDocs(a).then(function(e){a=[],n()}).catch(function(e){n(e,null)}))}}({objectMode:!0,highWaterMark:3});return c.pipe(i).pipe(s).pipe(u).on("finish",function(e){return l.bulkDocs(a).then(function(){l.put(n)}).catch(function(e){w("PUT DESCR ERR",e)})}).on("error",function(e){w("__stream final_err",e)})}(e,o).on("finish",function(e){let r=new I(o);r.dname=n,V.push(r),X(n),t(!0)}).on("error",function(e){throw new Error})}).catch(function(e){let o=$.get("cfg");J("IMP ERR CFG",o),V=r.a.filter(V,e=>e.dname!=n),function(e){$.get("upath");let t=$.get("cfg");t=r.a.filter(t,t=>t.dname!=e),$.set("cfg",t)}(n),t(!1)})}var ee=n(5);const te=n(6);console.log;if("production"!==ee.name){const e=a.app.getPath("userData");a.app.setPath("userData",`${e} (${ee.name})`)}a.app.on("ready",()=>{(()=>{const e=[u,d,p,f];ee.name,a.Menu.setApplicationMenu(a.Menu.buildFromTemplate(e))})();const e=new a.BrowserWindow({webPreferences:{nodeIntegration:!0}});let t=te.get("winBounds")||e.getBounds();t.y-=21,e.setBounds(t),e.loadURL(l.a.format({pathname:i.a.join(__dirname,"app.html"),protocol:"file:",slashes:!0})),"development"===ee.name&&e.openDevTools(),e.webContents.on("did-finish-load",()=>{let t=n(24),o=t.name,r=t.version;e.webContents.send("version",r),e.setTitle([o,"v.",r].join(" "))}),e.on("resize",function(){e.webContents.send("reload")}),e.on("close",()=>{te.set("winBounds",e.getBounds())}),a.globalShortcut.register("CommandOrControl+R",()=>e.reload());const o=a.app.getAppPath(),c=a.app.getPath("userData");te.set("apath",o),te.set("upath",c),K(c),a.ipcMain.on("infoDB",(e,t)=>{!function(e){let t=$.get("upath");A.resolve(t,"pouch",e),r.a.find(V,t=>t.dname==e).info().then(function(e){J("INFO",e)})}(t)}),a.ipcMain.on("queryDBs",(e,t)=>{Y(t).then(function(t){e.sender.send("replyDBs",t)})}),a.ipcMain.on("importCSV",(e,t)=>{Z(t,function(t){e.sender.send("csvImportReply",t)})}),a.ipcMain.on("exportCSV",(e,t)=>{!function(e,t){let n=r.a.find(V,t=>t.dname==e);n.allDocs({include_docs:!0,startkey:L,endkey:z}).then(function(o){let c=o.rows.map(e=>e.doc),i="";c.forEach(e=>{let t=e._id,n=e.docs.map(e=>e.trns),o=r.a.flatten(n).join(";"),c=[t,o.split(",").length>1?JSON.stringify(o):o].join(",");c=[c,"\n"].join(""),i+=c});let s=$.get("upath"),l=[e,"csv"].join("."),a=[e,"json"].join("."),u=A.resolve(s,l),p=A.resolve(s,a);N.writeFile(u,i,function(e){if(e&&J("ERRR",e),e)return t(!1);n.get("description").then(function(e){N.writeJson(p,e).then(()=>{t(!0)}).catch(e=>{console.error("JSONERR",e),t(!1)})})})})}(t,function(t){e.sender.send("csvExportReply",t)})}),a.ipcMain.on("scanDirectory",(e,t)=>{O(t).then(function(n){e.sender.send("scanReply",t)})}),a.ipcMain.on("remoteDicts",(e,t)=>{Q.listDatabases().then(function(e){let t=r.a.difference(e,["_users"]);return Promise.all(t.map(function(e){let t=["http://diglossa.org:5984/",e].join(""),n=new I(t);return n.info().then(e=>n.get("description").then(t=>({dname:e.db_name,size:e.doc_count,descr:t})).catch(e=>{J("REMOTE-ERR:",e)}))})).then(function(e){return e})}).then(function(t){t=r.a.filter(t,e=>"_"!=e[0]),e.sender.send("remoteDictsReply",t)}).catch(function(t){e.sender.send("remoteDictsReply",!1)})}),a.ipcMain.on("replicate",(e,t)=>{(function(e,t){let n=A.resolve(e,"pouch",t),o=new I(n),r=["http://diglossa.org/dump-",t].join(""),c=["http://diglossa.org:5984/",t].join("");return o.load(r).then(function(){o.sync(c,{live:!0,retry:!0}).on("change",H).on("error",U),o.dname=t,V.push(o),X(t)})})(c,t).then(function(t){e.sender.send("replicateReply",!0)}).catch(function(t){e.sender.send("replicateReply",!1)})}),a.ipcMain.on("cleanupDB",(e,t)=>{!function(e,t){let n=A.resolve(e,"pouch");try{V=[],N.removeSync(n),N.ensureDirSync(n),$.set("cfg",[]),t(!0)}catch(e){console.log("ERR re-creating DBs",e),t(!1)}}(c,function(t){e.sender.send("cleanupReply",t)})})}),a.app.on("window-all-closed",()=>{a.app.quit()})}]);
//# sourceMappingURL=background.js.map