!function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=22)}([function(t,e){t.exports=require("electron")},function(t,e){t.exports=require("lodash")},function(t,e,n){"use strict";n.d(e,"c",function(){return f}),n.d(e,"d",function(){return h}),n.d(e,"a",function(){return g}),n.d(e,"b",function(){return m});var i=n(1),o=n.n(i);const s=n(3),r=n(6),c=(n(7),n(4)),a=console.log,l=n(8);l.plugin(n(9));let d=[];const u=n(10),p=new u;new u({host:"couchdb.external.service",protocol:"https",port:6984}),new u({auth:{user:"login",pass:"secret"}});function f(){return p.listDatabases().catch(function(t){a("REMOTE DICTS ERR",t)})}function h(t,e){a("REPLICATE LOCAL",e);let n=new l(e);return n.info().then(function(t){return a("REPL-BEFORE-INFO",t),n.load("http://localhost:3000/dumps/dump.txt")})}function g(){let t=c.get("upath"),e=s.resolve(t,"pouch"),n=r.readdirSync(e),i=c.get("cfg")||[],u=[];return n.forEach((t,e)=>{let n=o.a.find(i,e=>e.name==t);if(n)u.push(n);else{let n={name:t,active:!0,idx:100+e};u.push(n)}}),(u=o.a.sortBy(u,"idx")).forEach((t,e)=>{t.idx=e}),c.set("cfg",u),function(t,e){d=[];let n=o.a.compact(e.map(t=>t.active?t.name:null));a("setDBNS",n),n.forEach((e,n)=>{let i=s.resolve(t,"pouch",e),o=new l(i);o.dname=e,o.weight=n,d.push(o)})}(t,u),u}function m(t){return Promise.all(d.map(function(e){return e.allDocs({keys:t,include_docs:!0}).then(function(t){if(!t||!t.rows)throw new Error("no dbn result");let n=o.a.compact(t.rows.map(t=>t.doc)),i=o.a.flatten(o.a.compact(n.map(t=>t.docs)));return i.length?(i.forEach(t=>{t.dname=e.dname,t.weight=e.weight}),a("======DOCS",i),i):[]}).catch(function(t){console.log("ERR GET DBs",t)})}))}},function(t,e){t.exports=require("path")},function(t,e){t.exports=require("electron-settings")},,function(t,e){t.exports=require("fs-extra")},function(t,e){t.exports=require("electron-is-dev")},function(t,e){t.exports=require("pouchdb")},function(t,e){t.exports=require("pouchdb-load")},function(t,e){t.exports=require("node-couchdb")},function(t,e){t.exports=require("electron-clipboard-extended")},function(t,e){t.exports=require("slash")},,function(t,e){t.exports=require("split.js")},function(t,e){t.exports=require("cholok")},,function(t,e){t.exports=require("util")},function(t,e){t.exports=require("pouchdb-authentication")},function(t,e){t.exports=require("mousetrap")},function(t,e){t.exports=require("json5")},function(t,e){t.exports=require("axios")},function(t,e,n){"use strict";n.r(e);var i=n(1),o=n.n(i),s=n(0);n(17);function r(t){return document.querySelector(t)}function c(t){return document.querySelectorAll(t)}function a(t,e){let n=document.createElement(t);return e&&n.classList.add(e),n}function l(t,e){let n=document.createElement("span");return n.textContent=t,e&&n.classList.add(e),n}function d(t){if(t)for(;t.hasChildNodes();)t.removeChild(t.lastChild)}function u(t){return t.getBoundingClientRect()}function p(t,e){let n=[t.top,"px"].join(""),i=[t.left,"px"].join("");e.style.top=n,e.style.left=i}function f(){return[].slice.call(document.querySelectorAll(":hover")).pop()}var h=n(14),g=n.n(h),m=n(15),b=n.n(m);const x="་",E=["འི","ར","འོ","འམ","འི","ས","འང"],C=n(0).remote.require("electron-settings");let v=x;const y=console.log;function w(t){if(!t||!t.pars||!t.pars.length)return;let e=t.pars,n=r("#source"),i=r("#result");d(n),d(i),e.forEach(t=>{let e=function(t,e){let n=document.createElement("p");return n.textContent=t,e&&n.classList.add(e),n}();e.classList.add("tibpar"),t.forEach(t=>{let n=l(t.text);t.tib&&n.classList.add("tibphrase"),t.punct&&n.classList.add("punct")," "==t.text&&n.classList.add("space"),e.appendChild(n)}),n.appendChild(e)});c("span.tibetan")}function L(t){let e=u(t),n=b()(t.textContent),i={top:e.top-40,left:e.left+15},o=r("#transcript");o.textContent=n,o.classList.remove("is-hidden"),p(i,o)}function S(t,e){let n;try{n=JSON.parse(t.dataset.chains)}catch(e){return void y("ERR: JSON chains",t)}let i=!t.closest(".tibpar"),o=function(t,e){let n;e?((n=a("div","popup")).classList.add("upper"),document.body.appendChild(n)):n=r("#ambi");let i=u(t);d(n),n.classList.remove("is-hidden"),p({top:i.bottom-3,left:i.left},n);let o=a("ul","ambilist");return n.appendChild(o),o}(t,i);e?function(t,e){e.forEach(e=>{let n,i=a("li","ambiline");t.appendChild(i),e.ambi?(n=l(e.seg,"tibambi")).dataset.chains=JSON.stringify(e.chains):e.docs.length?(n=l(e.seg,"tibwf")).dataset.docs=JSON.stringify(e.docs):n=l(e.seg,"tibphrase"),i.appendChild(n)})}(o,n):function(t,e){t.classList.add("danger"),e.forEach(e=>{let n=a("li","ambiline");t.appendChild(n),e.forEach(t=>{let e=t.docs.length?l(t.seg,"tibwf"):l(t.seg,"tibphrase");t.docs.length&&(e.dataset.docs=JSON.stringify(t.docs)),n.appendChild(e)})})}(o,n),r("#progress").classList.remove("is-shown")}var O=n(2);console.log;const R=n(4);function q(){let t=R.get("cfg"),e=(t.map(t=>t.name),r("#local-dicts-table tbody"));d(e),t.forEach(t=>{let n=t.name,i=a("tr");e.appendChild(i);let s=a("td","dictname");i.appendChild(s),s.textContent=o.a.capitalize(n),s.dataset.firstdict=n;let r=a("td","active-dict");if(t.active){let t=j();r.appendChild(t)}else r.textContent="activate";r.dataset.activedict=n,i.appendChild(r)})}function N(t){let e=R.get("cfg"),n=o.a.find(e,e=>e.name==t.dataset.activedict),i=j();t.textContent?(t.textContent="",t.appendChild(i),n.active=!0):(d(t),t.textContent="activate",n.active=!1),R.set("cfg",e)}function j(){let t=a("img","dict-check");return t.setAttribute("src","../resources/check.png"),t}s.ipcRenderer.on("remoteDictsReply",function(t,e){!function(t){let e=R.get("cfg"),n=["_users"],i=e.map(t=>t.name),s=o.a.uniq(n.concat(i)),c=r("#server-dicts-table tbody");d(c),t.forEach(t=>{if(n.includes(t))return;let e=a("tr");c.appendChild(e);let i=a("td");e.appendChild(i),i.textContent=o.a.capitalize(t);let r=a("td","link");if(s.includes(t)){let t=j();r.appendChild(t)}else r.textContent="sync";r.dataset.clone=t,e.appendChild(r)})}(e)}),s.ipcRenderer.on("replicateOK",function(t,e){M({section:"activedicts"})});const J=n(3),k=(n(4),console.log),D=n(8);D.plugin(n(18));const P=s.remote.app,T=(P.getAppPath(),P.getPath("userData")),z=console.log,A=(n(11),n(0).remote.require("electron-settings")),B=n(19),{getCurrentWindow:_}=(n(6),n(3),n(12),n(0).remote);let I,K=[],U=0;function M(t){try{t=JSON.parse(JSON.stringify(t))}catch(e){z("NAV-state ERR",e),t={}}let e=t.section||"home";e||(t.section="home"),function(t){(function(){const t=document.querySelectorAll(".section.is-shown");Array.prototype.forEach.call(t,t=>{t.classList.remove("is-shown")}),r("#transcript").classList.add("is-hidden"),r("#ambi").classList.add("is-hidden")})(),r(["#",t].join("")).classList.add("is-shown")}(t.section),t.old||(t.old=!1,delete t.old,K.push(t),U=K.length-1);let n=r("#progress");"main"==e?(function(t){let e=A.get("split-sizes")||[50,50];I&&t.mono?I.collapse(1):I&&I.setSizes(e),I||(A.set("split-sizes",e),I=g()(["#source","#result"],{sizes:e,gutterSize:5,cursor:"col-resize",minSize:[0,0],onDragEnd:function(t){A.set("split-sizes",t),_().reload()}}),t.mono&&I.collapse(1),document.addEventListener("keydown",function(t){},!1),document.addEventListener("wheel",function(t){},!1))}(t),w(t)):"clonedicts"==e?s.ipcRenderer.send("remoteDicts",""):"activedicts"==e?q():n.classList.remove("is-shown"),A.set("state",t)}B.bind(["alt+left","alt+right"],function(t){37==t.which?function(){if(U<=0)return;U--;let t=K[U];t.old=!0,M(t)}():39==t.which&&function(){if(U>=K.length-1)return;U++;let t=K[U];t.old=!0,M(t)}()}),B.bind(["alt+1","alt+2"],function(t){}),B.bind(["esc"],function(t){}),B.bind(["ctrl+u"],function(t){z("CLICK SIGNUP"),function(t){let e=new D("http://localhost:5984/mydb",{skip_setup:!0}),n=J.resolve(t,"pouch","auth");new D(n).sync(e,{live:!0,retry:!0}).on("error",console.log.bind(console)),e.signUp("batman","brucewayne",function(t,e){t&&("conflict"===t.name||t.name)}).then(function(t){k("SIGNUP RES",t)})}(T)}),B.bind(["ctrl+i"],function(t){let e=Object(O.a)(),n=JSON.parse(JSON.stringify(e));z("RE-INIT-DBs",n)});console.log;let F={zho:"([一-鿿]+)",tib:"([ༀ-࿿]+)",grc:"([Ͱ-Ͽἀ-῿̀-ͯ']+)"};console.log;const G=x;let W=x;console.log;function V(t,e){r("#progress").classList.add("is-shown");let n,i=t.textContent.trim(),c=new RegExp(W+"$"),a=i.replace(c,""),l=o.a.last(i)==W,d=function(t){let e=t.split(G),n=e.length<10?10:2,i=t,s=(e.length,[[e]]);!function t(e,r){(function(t){let e,n,i=[];for(let o=1;o<t.length+1;o++){e=t.slice(0,o),n=t.slice(o);let s={head:e,tail:n};n.length&&i.push(s)}return i.reverse()})(e).forEach(e=>{r.push(e.head),r.push(e.tail),o.a.flatten(r).join(G)==i&&(s.push(o.a.clone(r)),r.pop()),r.length<n&&t(e.tail,r),r.pop()})}(e,[]);let r=[];return s.forEach(t=>{let e=[];t.forEach(t=>{e.push(t.join(G))}),r.push(e)}),r}(a),u=function(t){let e=o.a.uniq(o.a.flatten(t)),n=[];return e.forEach(t=>{E.forEach(e=>{let i=new RegExp(e+"$"),o=t.replace(i,"");t!=o&&n.push(o)})}),{main:e,added:n}}(d),p={keys:n=e?o.a.filter(u.main,t=>t!=a):o.a.uniq(u.main.concat(u.added)),pdchs:d,compound:e,lastsek:l};s.ipcRenderer.send("queryDBs",p)}function $(t){let e=o.a.max(t.map(t=>o.a.sum(t.map(t=>t.docs.length?t.seg.length:0))/t.length)),n=o.a.filter(t,t=>o.a.sum(t.map(t=>t.docs.length?t.seg.length:0))/t.length>=e-1),i=o.a.min(n.map(t=>t.length));return o.a.filter(n,t=>t.length==i)}s.ipcRenderer.on("replayDBs",function(t,e){!function(t){let e,n=f(),i=o.a.flatten(t.docs),s=function(t,e){let n,i,s=[],r=[];t.forEach(t=>{let n=[],i=!1,c=!0;t.forEach(t=>{let s=o.a.filter(e,e=>(function(t,e){if(t==e)return!0;let n=new RegExp("^"+e),i=t.replace(n,"");return!(t==i||!E.includes(i))})(t,e.dict));s.length&&(i=!0),s.length||(c=!1);let r={seg:t,docs:s};n.push(r)}),i&&s.push(n),c&&r.push(n)}),r.length?(n=$(r),i=!0):n=$(s);return{chains:n,full:i}}(t.pdchs,i).chains;if(s.length>1)e=function(t){let e,n=t[0],i=[];for(let s=0;s<n.length;s++){let r=t.map(t=>t[s].seg);if(1==o.a.uniq(r).length)i.push(n[s]),e=null;else{e||(e={ambi:!0,seg:"",docs:[]},i.push(e));let n=t.map(t=>({seg:t[s].seg,docs:t[s].docs}));e.docs.push(n)}}return o.a.filter(i,t=>t.ambi).forEach(t=>{let e=t.docs[0],n=[];for(let i=0;i<e.length;i++){let e=t.docs.map(t=>t[i]);n.push(e)}t.chains=n;let i=n[0];t.seg=i.map(t=>t.seg).join(W)}),i}(s);else{if(1!=s.length)return y("NO RESULT"),void r("#progress").classList.remove("is-shown");e=s[0]}t.compound?(n.dataset.chains=JSON.stringify(e),S(n,!0)):function(t,e,n){t.textContent="",e.forEach((n,i)=>{let o;n.ambi?(o=l(n.seg,"tibambi")).dataset.chains=JSON.stringify(n.chains):n.docs.length?(o=l(n.seg,"tibwf")).dataset.docs=JSON.stringify(n.docs):o=l(n.seg,"tibphrase"),t.appendChild(o),i<e.length-1&&t.appendChild(l(v,"tsek"))}),n&&t.appendChild(l(v,"tsek")),r("#progress").classList.remove("is-shown")}(n,e,t.lastsek)}(e)});const H=n(0).remote.require("electron-settings"),Q=(n(20),n(21),n(12),console.log),X=(n(3),n(11)),{dialog:Y,getCurrentWindow:Z}=n(0).remote;n(7);r("#new-version");let tt=r("#container");c('link[rel="import"]').forEach(t=>{let e=t.import.querySelector(".section");tt.appendChild(e.cloneNode(!0))}),s.ipcRenderer.on("section",function(t,e){M({section:e})}),s.ipcRenderer.on("action",function(t,e){"clonedicts"==e?M({section:"clone"}):"arrangeDicts"==e?M({section:"activedicts"}):"csv"==e?Y.showOpenDialog({properties:["openFile"],filters:[{name:"JSON",extensions:["stardict"]}]},parseCSV):"cleanupdb"==e&&M({section:"clone"})}),s.ipcRenderer.on("reread",function(t){let e=H.get("state");Z().reload(),M(e)});let et=H.get("state");et||(et={section:"home"}),M(et),document.addEventListener("click",t=>{let e=t.target.dataset;if(!e)return;let n=t.target.parentElement;if(t.target.classList.contains("external")){let e=t.target.textContent;s.shell.openExternal(e)}else e.section?M({section:e.section}):e.clone?s.ipcRenderer.send("replicate",e.clone):e.firstdict?function(t){let e=R.get("cfg"),n=o.a.find(e,e=>e.name==t),i=o.a.reject(e,e=>e.name==t);i.unshift(n),(e=i).forEach((t,e)=>{t.idx=e}),R.set("cfg",e),Object(O.a)(),q()}(e.firstdict):e.activedict?N(t.target):n.dataset.activedict?N(n):"cleanupdb"==t.target.id?Q("CLEAN UP DBs!"):e.docs&&V(t.target,!0)}),document.addEventListener("mouseover",function(t){if(!t.target.textContent)return;if(1==t.ctrlKey)return;t.target.closest(".tibpar")&&c(".popup").forEach(t=>{t.classList.add("is-hidden")}),t.target.classList.contains("tibphrase")?1==t.shiftKey?L(t.target):V(t.target):t.target.classList.contains("tibwf")?function(t){r("#source");let e=r("#result");d(e);let n=t.textContent,i=JSON.parse(t.dataset.docs);try{i=JSON.parse(t.dataset.docs)}catch(t){return void y("ERR: JSON docs")}let s=C.get("cfg"),c=JSON.parse(JSON.stringify(s));y("CFG",c),y("RESULT docs",n,i),i.forEach(t=>{t.weight=o.a.find(s,e=>t.dname==e.name).idx}),i=o.a.sortBy(i,"weight"),y("RESULT docs",n,i);let l=a("div","dict");e.appendChild(l);let u=a("p","dict-wf");u.textContent=n,l.appendChild(u),i.forEach(t=>{let e=a("p","dict-dname");e.textContent=t.dname,l.appendChild(e);let n=a("p","dict-article");n.textContent=t.dict,l.appendChild(n);let i=a("ul","dict-ul");l.appendChild(i),t.trns||y("NO TRNS",t),t.trns&&t.trns.forEach(t=>{let e=a("li","dict-line");e.textContent=t,i.appendChild(e)})})}(t.target):t.target.classList.contains("tibambi")&&S(t.target)},!1),document.addEventListener("mouseleave",function(t){if(t.target.classList&&1!=t.ctrlKey&&t.target.classList.contains("tibphrase")){r("#transcript").classList.add("is-hidden")}},!1),document.addEventListener("keyup",function(t){if(1==t.ctrlKey)return;r("#transcript").classList.add("is-hidden")},!1),document.addEventListener("keydown",function(t){if(1==t.ctrlKey)return;if(1!=t.shiftKey)return;let e=f();"source"==e.id&&(e=r(".tibpar")),L(e)},!1),X.on("text-changed",()=>{let t=((t,e)=>{let n=new RegExp(F[t]);if(!n.test(e))return;let i=e.trim().replace(/᾽/g,"'"),s=i.split("'").join("");if(!n.test(s))return;let r=new RegExp("([.,!:;·།])"),c=i.replace(/\r?\n+/,"\n").split("\n"),a=(c.map(t=>t.split(r)),[]);return c.forEach(e=>{let i=[];e.split(r).forEach(e=>{if(r.test(e)){let t={text:e,punct:!0};i.push(t)}else{let s=e.split(n);(s=o.a.compact(s)).forEach(e=>{let o={text:e};!!n.test(e)&&(o[t]=!0),i.push(o)})}}),a.push(i)}),a})("tib",X.readText());t&&t.length&&M({section:"main",pars:t})}).startWatching()}]);
//# sourceMappingURL=app.js.map