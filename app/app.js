!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=32)}([function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("electron")},function(e,t,n){"use strict";n.d(t,"b",function(){return i}),n.d(t,"a",function(){return r});const i={tsek:"་"},r=["འི","ར","འོ","འམ","འི","ས","འང"]},function(e,t,n){"use strict";var i=n(0),r=n.n(i),o=n(5),s=n.n(o),c=n(2);console.log;const a=c.b.tsek;n.d(t,"f",function(){return S}),n.d(t,"g",function(){return L}),n.d(t,"c",function(){return w}),n.d(t,"a",function(){return R}),n.d(t,"e",function(){return q}),n.d(t,"d",function(){return D}),n.d(t,"b",function(){return A});const l=c.b.tsek;let d=new RegExp(l+"$");n(12);const u=n(4),p=n(13);let f=n(14)({gitignore:!0});n(9);const h=n(6),g=n(10);g.plugin(n(15));const m=console.log;n(7),n(16);let v=n(17),b=(n(18),"tib"),E=[],x=/༈/;const y=n(19),C=(new y,new y({host:"diglossa.org",protocol:"http",port:5984,auth:{user:"guest",pass:"guest"}}));function S(){return C.listDatabases().catch(function(e){throw m("REMOTE DICTS ERR",e),new Error(e)})}function L(e,t){let n=u.resolve(e,"pouch",t),i=new g(n),r=["http://diglossa.org/dump-",t].join("");return m("REPLICATE START",n,r),i.info().then(function(e){m("REPL-BEFORE-INFO",e),i.load(r).then(function(e){return m("REPL OK, getting CFG"),w})}).catch(function(e){throw i.destroy(),new Error(e)})}function w(){let e=h.get("upath"),t=u.resolve(e,"pouch");p.ensureDirSync(t);let n=p.readdirSync(t),i=h.get("cfg")||[],o=[];return n.forEach((e,t)=>{let n=r.a.find(i,t=>t.name==e);if(n)o.push(n);else{let n={name:e,active:!0,idx:100+t};o.push(n)}}),(o=r.a.sortBy(o,"idx")).forEach((e,t)=>{e.idx=t}),h.set("cfg",o),function(e,t){E=[];let n=r.a.compact(t.map(e=>e.active?e.name:null));n.forEach((t,n)=>{let i=u.resolve(e,"pouch",t),r=new g(i);r.dname=t,r.weight=n,E.push(r)})}(e,o),o}function R(e){let t=u.resolve(e,"pouch");m("CLEAN UP",t);try{p.removeSync(t),w()}catch(e){m("ERR re-creating DBs",e)}}function q(e){e.str.replace(x,"");let t,n=function(e){let t=e.split(a),n=4,i=e,o=(t.length,[[t]]);!function e(t,s){(function(e){let t,n,i=[];for(let r=1;r<e.length+1;r++){t=e.slice(0,r),n=e.slice(r);let o={head:t,tail:n};n.length&&i.push(o)}return i.reverse()})(t).forEach(t=>{s.push(t.head),s.push(t.tail),r.a.flatten(s).join(a)==i&&(o.push(r.a.clone(s)),s.pop()),s.length<n&&e(t.tail,s),s.pop()})}(t,[]);let s=[];return o.forEach(e=>{let t=[];e.forEach(e=>{t.push(e.join(a))}),s.push(t)}),s}(e.str),i=function(e){let t=r.a.uniq(r.a.flatten(e)),n=[];return t.forEach(e=>{c.a.forEach(t=>{let i=new RegExp(t+"$"),r=e.replace(i,"");e!=r&&n.push(r)})}),{main:t,added:n}}(n);return t=e.compound?r.a.filter(i.main,t=>t!=e.str):r.a.uniq(i.main.concat(i.added)),Promise.all(E.map(function(e){return e.allDocs({keys:t,include_docs:!0}).then(function(t){if(!t||!t.rows)throw new Error("no dbn result");let n=r.a.compact(t.rows.map(e=>e.doc)),i=r.a.flatten(r.a.compact(n.map(e=>e.docs)));return i.forEach(t=>{t.dname=e.dname,t.weight=e.weight}),i}).catch(function(e){console.log("ERR GET DBs",e)})})).then(function(t){let i=function(e,t){let n,i=function(e,t){let n,i,o=[],s=[];e.forEach(e=>{let n=[],i=!1,a=!0;e.forEach(e=>{let o=r.a.filter(t,t=>(function(e,t){if(e==t)return!0;let n=new RegExp("^"+t),i=e.replace(n,"");return!(e==i||!c.a.includes(i))})(e,t.dict));o.length&&(i=!0),o.length||(a=!1);let s={seg:e,docs:o};n.push(s)}),i&&o.push(n),a&&s.push(n)}),s.length?(n=_(s),i=!0):n=_(o);return{chains:n,full:i}}(t,e).chains;i.length>1?n=function(e){let t,n=e[0],i=[];for(let o=0;o<n.length;o++){let s=e.map(e=>e[o].seg);if(1==r.a.uniq(s).length)i.push(n[o]),t=null;else{t||(t={ambi:!0,seg:"",docs:[]},i.push(t));let n=e.map(e=>({seg:e[o].seg,docs:e[o].docs}));t.docs.push(n)}}return r.a.filter(i,e=>e.ambi).forEach(e=>{let t=e.docs[0],n=[];for(let i=0;i<t.length;i++){let t=e.docs.map(e=>e[i]);n.push(t)}e.chains=n;let i=n[0];e.seg=i.map(e=>e.seg).join(l)}),i}(i):1==i.length&&(n=i[0]);return n}(r.a.flatten(t),n);return e.chain=i,e})}function _(e){let t=r.a.max(e.map(e=>r.a.sum(e.map(e=>e.docs.length?e.seg.length:0))/e.length)),n=r.a.filter(e,e=>r.a.sum(e.map(e=>e.docs.length?e.seg.length:0))/e.length>=t-1),i=r.a.min(n.map(e=>e.length));return r.a.filter(n,e=>e.length==i)}let O=[],N=[],j=[];function D(e){m("LOCAL",e),e=u.resolve(__dirname,e);let t=f.readdirSync("**/*.tib*",{cwd:e}),n=function(e,t){let n=[],i={};return t.forEach(t=>{let o=u.resolve(e,t),c=p.readFileSync(o,"utf8").trim().split("\n");(c=r.a.compact(c)).forEach((e,t)=>{let r=function(e){let t=e.trim();return t=t.trim().replace(/\.$/,"")}(e);s()(r,b).forEach(e=>{e.forEach(e=>{e.lang==b&&e.text.split(" ").forEach(e=>{e=e.replace(d,""),i[e]||(n.push(e),i[e]=!0)})})})})}),n}(e,t=r.a.uniq(t));m("WFS",n.length);let i=n.map(e=>({str:e}));i=i.slice(0,3),m("QS2",i),k(i)}function k(e){let t=v.from.obj(e),n=v.to.obj(P,J),i=v.through.obj(function(e,t,n){q(e).then(function(e){n(null,e)})});v.pipe(t,i,n,function(e){if(e)return console.error("Copy error!",e);console.log("Copied successfully")})}function P(e,t,n){if(m("_dbres_:",e),!e.chain)return n();e.chain.forEach(e=>{e.docs.length?O.push(e.seg):j.push(e.seg)}),n()}function J(e){if(j=r.a.uniq(j),O=r.a.uniq(O),N.length==O.length)return m("__VERY END__",O);if(N.length=O.length,m("FLUSH: DICTS",O.length,"QS",j),j.length){k(j.map(e=>({str:e})))}else m("____THE END____")}let T="ཀ",z="￰";function A(e){m("export to CSV",e);let t=r.a.find(E,t=>t.dname==e);return m("export DB",t.dname),t.allDocs({include_docs:!0,startkey:T,endkey:z}).then(function(t){let n=h.get("upath"),i=t.rows.map(e=>e.doc),o="";i.forEach(e=>{let t=e._id,n=e.docs.map(e=>e.trns),i=r.a.flatten(n).join(";"),s=[t,i.split(",").length>1?JSON.stringify(i):i].join(",");s=[s,"\n"].join(""),o+=s});let s=[e,"csv"].join("."),c=u.resolve(n,s);p.writeFile(c,o,function(e){return console.log("The file was saved!"),!0})})}},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i;(i=n(11))&&i.__esModule;var r=n(0),o=(console.log,n(7)("app"),{zho:"([一-鿿]+)",tib:"([ༀ-࿿]+)",grc:"([Ͱ-Ͽἀ-῿̀-ͯ' ]+)"});t.default=function(e,t){var n=new RegExp(o[t]);if(n.test(e)){var i=e.trim().replace(/᾽/g,"'"),s=i.split("'").join("");if(n.test(s)){var c=new RegExp("([.,!:;·།])"),a=i.replace(/\r?\n+/,"\n").split("\n"),l=(a.map(function(e){return e.split(c)}),[]);return a.forEach(function(e){var i=[];e.split(c).forEach(function(e){if(c.test(e)){var o={text:e,punct:!0};i.push(o)}else{var s=e.split(n);(s=r.compact(s)).forEach(function(e){if(e=e.trim()){var r={text:e};!!n.test(e)&&(r.lang=t),i.push(r)}})}}),l.push(i)}),l}}}},function(e,t){e.exports=require("electron-settings")},function(e,t){e.exports=require("debug")},,function(e,t){e.exports=require("electron-is-dev")},function(e,t){e.exports=require("pouchdb")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;t.default=function(){return"new message"}},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=require("glob-fs")},function(e,t){e.exports=require("pouchdb-load")},function(e,t){e.exports=require("highland")},function(e,t){e.exports=require("mississippi")},function(e,t){e.exports=require("csv2")},function(e,t){e.exports=require("node-couchdb")},function(e,t){e.exports=require("cholok")},function(e,t){e.exports=require("electron-clipboard-extended")},function(e,t){e.exports=require("slash")},,function(e,t){e.exports=require("split.js")},,function(e,t){e.exports=require("util")},function(e,t){e.exports=require("pouchdb-authentication")},function(e,t){e.exports=require("mousetrap")},function(e,t){e.exports=require("json5")},function(e,t){e.exports=require("axios")},,function(e,t,n){"use strict";n.r(t);var i=n(0),r=n.n(i),o=n(1);n(26);function s(e){return document.querySelector(e)}function c(e){return document.querySelectorAll(e)}function a(e,t){let n=document.createElement(e);return t&&n.classList.add(t),n}function l(e,t){let n=document.createElement("span");return n.textContent=e,t&&n.classList.add(t),n}function d(e){if(e)for(;e.hasChildNodes();)e.removeChild(e.lastChild)}function u(e){return e.getBoundingClientRect()}function p(e,t){let n=[e.top,"px"].join(""),i=[e.left,"px"].join("");t.style.top=n,t.style.left=i}function f(){return[].slice.call(document.querySelectorAll(":hover")).pop()}var h=n(24),g=n.n(h),m=n(20),v=n.n(m),b=n(2);const E=n(1).remote.require("electron-settings");let x=b.b.tsek;const y=console.log;function C(e){let t=e.pars,n=s("#source"),i=s("#result");d(n),d(i),t.forEach(e=>{let t=function(e,t){let n=document.createElement("p");return n.textContent=e,t&&n.classList.add(t),n}();t.classList.add("tibpar"),e.forEach(e=>{let n=l(e.text);e.lang?n.classList.add("tibphrase"):e.punct?n.classList.add("punct"):n.classList.add("space"),t.appendChild(n)}),n.appendChild(t)});c("span.tibetan")}function S(e,t){let n=u(e),i=t?v()(e.textContent,!0):v()(e.textContent),r={top:n.top-40,left:n.left+15},o=s("#transcript");o.textContent=i,o.classList.remove("is-hidden"),p(r,o)}function L(e,t){let n;try{n=JSON.parse(e.dataset.chains)}catch(t){return void y("ERR: JSON chains",e)}let i=!e.closest(".tibpar"),r=function(e,t){let n;t?((n=a("div","popup")).classList.add("upper"),document.body.appendChild(n)):n=s("#ambi");let i=u(e);d(n),n.classList.remove("is-hidden"),p({top:i.bottom-3,left:i.left},n);let r=a("ul","ambilist");return n.appendChild(r),r}(e,i);t?function(e,t){t.forEach(t=>{let n,i=a("li","ambiline");e.appendChild(i),t.ambi?(n=l(t.seg,"tibambi")).dataset.chains=JSON.stringify(t.chains):t.docs.length?(n=l(t.seg,"tibwf")).dataset.docs=JSON.stringify(t.docs):n=l(t.seg,"tibphrase"),i.appendChild(n)})}(r,n):function(e,t){e.classList.add("danger"),t.forEach(t=>{let n=a("li","ambiline");e.appendChild(n),t.forEach(e=>{let t=e.docs.length?l(e.seg,"tibwf"):l(e.seg,"tibphrase");e.docs.length&&(t.dataset.docs=JSON.stringify(e.docs)),n.appendChild(t)})})}(r,n)}function w(e,t){s("#progress").classList.remove("is-hidden");let n=e.textContent.trim(),i=new RegExp(x+"$"),c={str:n.replace(i,""),compound:t,lastsek:r.a.last(n)==x};o.ipcRenderer.send("queryDBs",c)}o.ipcRenderer.on("replayDBs",function(e,t){s("#progress").classList.remove("is-hidden");let n=t.chain,i=f();n&&(t.compound?(i.dataset.chains=JSON.stringify(n),L(i,!0)):function(e,t,n){e&&(e.textContent="",t.forEach((n,i)=>{let r;n.ambi?(r=l(n.seg,"tibambi")).dataset.chains=JSON.stringify(n.chains):n.docs.length?(r=l(n.seg,"tibwf")).dataset.docs=JSON.stringify(n.docs):r=l(n.seg,"tibphrase"),e.appendChild(r),i<t.length-1&&e.appendChild(l(x,"tsek"))}),n&&e.appendChild(l(x,"tsek")))}(i,n,t.lastsek))});var R=n(3);console.log;const q=n(6);function _(){let e=q.get("cfg"),t=(e.map(e=>e.name),s("#local-dicts-table tbody"));d(t),e.forEach(e=>{let n=e.name,i=a("tr");t.appendChild(i);let o=a("td","dictname");i.appendChild(o),o.textContent=r.a.capitalize(n),o.dataset.firstdict=n;let s=a("td","active-dict");if(e.active){let e=O();s.appendChild(e)}else s.textContent="activate";s.dataset.activedict=n,i.appendChild(s);let c=a("td","dictcsv");c.textContent="toCSV",c.dataset.csv=n,i.appendChild(c)})}function O(){let e=a("img","dict-check");return e.setAttribute("src","../resources/check.png"),e}o.ipcRenderer.on("remoteDictsReply",function(e,t){let n=s("#cloneERR");s("#progress").classList.add("is-hidden"),t?function(e){let t=q.get("cfg"),n=["_users"],i=t.map(e=>e.name),o=r.a.uniq(n.concat(i)),c=s("#server-dicts-table tbody");d(c),e.forEach(e=>{if(n.includes(e))return;let t=a("tr");c.appendChild(t);let i=a("td");t.appendChild(i),i.textContent=r.a.capitalize(e);let s=a("td","link");if(o.includes(e)){let e=O();s.appendChild(e)}else s.textContent="sync";s.dataset.clone=e,t.appendChild(s)})}(t):n.classList.remove("is-hidden")}),o.ipcRenderer.on("replicateReply",function(e,t){let n=s("#cloneERR"),i=s("#progress");t?i.classList.add("is-hidden"):n.classList.remove("is-hidden")});const N=n(4),j=(n(6),console.log),D=n(10);D.plugin(n(27));const k=o.remote.app,P=(k.getAppPath(),k.getPath("userData")),J=console.log,T=(n(21),n(1).remote.require("electron-settings")),z=n(28),{getCurrentWindow:A}=(n(4),n(22),n(1).remote);let B,F=[],K=0;function M(e){try{e=JSON.parse(JSON.stringify(e))}catch(t){J("NAV-state ERR",t),e={}}let t=e.section||"home";t||(e.section="home"),function(e){I();const t=["#",e].join("");J("S",t),s(t).classList.remove("is-hidden")}(e.section),e.old||(e.old=!1,delete e.old,F.push(e),K=F.length-1),"main"==t?(function(e){let t=T.get("split-sizes")||[50,50];B&&e.mono?B.collapse(1):B&&B.setSizes(t),B||(T.set("split-sizes",t),B=g()(["#source","#result"],{sizes:t,gutterSize:5,cursor:"col-resize",minSize:[0,0],onDragEnd:function(e){T.set("split-sizes",e),A().reload()}}),e.mono&&B.collapse(1),document.addEventListener("keydown",function(e){},!1),document.addEventListener("wheel",function(e){},!1))}(e),C(e)):"clonedicts"==t?o.ipcRenderer.send("remoteDicts",""):"activedicts"==t&&_(),s("#progress").classList.add("is-hidden"),T.set("state",e)}function I(){const e=document.querySelectorAll(".section");Array.prototype.forEach.call(e,e=>{e.classList.add("is-hidden")}),s("#transcript").classList.add("is-hidden"),s("#ambi").classList.add("is-hidden")}z.bind(["alt+left","alt+right"],function(e){37==e.which?function(){if(K<=0)return;K--;let e=F[K];e.old=!0,I(),M(e)}():39==e.which&&function(){if(K>=F.length-1)return;K++;let e=F[K];e.old=!0,I(),M(e)}()}),z.bind(["alt+1","alt+2"],function(e){}),z.bind(["esc"],function(e){}),z.bind(["ctrl+d"],function(e){o.ipcRenderer.send("queryLocalDict","/home/michael/diglossa.texts/Tibetan")}),z.bind(["ctrl+u"],function(e){J("CLICK SIGNUP"),function(e){let t=new D("http://localhost:5984/mydb",{skip_setup:!0}),n=N.resolve(e,"pouch","auth");new D(n).sync(t,{live:!0,retry:!0}).on("error",console.log.bind(console)),t.signUp("batman","brucewayne",function(e,t){e&&("conflict"===e.name||e.name)}).then(function(e){j("SIGNUP RES",e)})}(P)});var U=n(5),V=n.n(U);n.d(t,"scrollPane",function(){return Z});const G=n(1).remote.require("electron-settings"),W=(n(29),n(30),n(22),console.log),$=(n(4),n(21)),{dialog:H,getCurrentWindow:Q}=n(1).remote;n(9);s("#new-version");let Y=s("#container");c('link[rel="import"]').forEach(e=>{let t=e.import.querySelector(".section");Y.appendChild(t.cloneNode(!0))}),o.ipcRenderer.on("section",function(e,t){M({section:t})}),o.ipcRenderer.on("reread",function(e){let t=G.get("state");Q().reload(),M(t)});let X=G.get("state");function Z(e,t){if(1==e.shiftKey)return;let n=e.deltaY>0?24:-24;s(".section.is-shown").scrollTop+=n}function ee(e){W("FNS",e)}function te(e){if(W("FNS",e),!e)return;let t=e[0];t&&o.ipcRenderer.send("importcsv",t)}X||(X={section:"home"}),M(X),document.addEventListener("click",e=>{let t=s("#progress"),n=e.target.dataset;if(!n)return;let i=e.target.parentElement;if(e.target.classList.contains("external")){let t=e.target.textContent;o.shell.openExternal(t)}else n.section?M({section:n.section}):n.clone?(t.classList.remove("is-hidden"),o.ipcRenderer.send("replicate",n.clone)):n.firstdict?function(e){let t=q.get("cfg"),n=r.a.find(t,t=>t.name==e),i=r.a.reject(t,t=>t.name==e);i.unshift(n),(t=i).forEach((e,t)=>{e.idx=t}),q.set("cfg",t),Object(R.c)(),_()}(n.firstdict):n.activedict?function(e){let t=q.get("cfg"),n=r.a.find(t,t=>t.name==e.dataset.activedict),i=O();e.textContent?(e.textContent="",e.appendChild(i),n.active=!0):(d(e),e.textContent="activate",n.active=!1),q.set("cfg",t)}(e.target):n.csv?(t.classList.remove("is-hidden"),o.ipcRenderer.send("export-to-csv",n.csv)):i&&i.dataset&&i.dataset.activedict?W("activateDict(parent)_______"):"cleanupdb"==e.target.id?o.ipcRenderer.send("cleanupDB"):"scandir"==e.target.id?H.showOpenDialog({properties:["openDirectory"]},ee):"importcsv"==e.target.id?H.showOpenDialog({properties:["openDir"],filters:[{name:"CSV",extensions:["csv"]}]},te):n.docs&&w(e.target,!0)}),document.addEventListener("mouseover",function(e){if(!e.target.textContent)return;if(1==e.ctrlKey)return;e.target.closest(".tibpar")&&c(".popup").forEach(e=>{e.classList.add("is-hidden")}),e.target.classList.contains("tibphrase")?1==e.shiftKey||w(e.target):e.target.classList.contains("tibwf")?function(e){s("#source");let t=s("#result");d(t);let n=e.textContent,i=JSON.parse(e.dataset.docs);try{i=JSON.parse(e.dataset.docs)}catch(e){return void y("ERR: JSON docs")}let o=E.get("cfg");JSON.parse(JSON.stringify(o)),i.forEach(e=>{e.weight=r.a.find(o,t=>e.dname==t.name).idx}),i=r.a.sortBy(i,"weight");let c=a("div","dict");t.appendChild(c);let l=a("p","dict-wf");l.textContent=n,c.appendChild(l),i.forEach(e=>{let t=a("p","dict-dname");t.textContent=e.dname,c.appendChild(t);let n=a("p","dict-article");n.textContent=e.dict,c.appendChild(n);let i=a("ul","dict-ul");c.appendChild(i),e.trns||y("NO TRNS",e),e.trns&&e.trns.forEach(e=>{let t=a("li","dict-line");t.textContent=e,i.appendChild(t)})})}(e.target):e.target.classList.contains("tibambi")&&L(e.target)},!1),document.addEventListener("mouseleave",function(e){if(e.target.classList&&1!=e.ctrlKey&&e.target.classList.contains("tibphrase")){s("#transcript").classList.add("is-hidden")}},!1),document.addEventListener("keyup",function(e){if(1==e.ctrlKey)return;s("#transcript").classList.add("is-hidden")},!1),document.addEventListener("keydown",function(e){if(1!=e.shiftKey)return;let t=f();t&&("source"==t.id&&(t=s(".tibpar")),S(t),1==e.ctrlKey&&S(t,!0))},!1),document.addEventListener("wheel",function(e){Z(e,X)},!1),$.on("text-changed",()=>{let e=$.readText(),t=V()(e,"tib");t&&t.length&&M({section:"main",pars:t})}).startWatching()}]);
//# sourceMappingURL=app.js.map