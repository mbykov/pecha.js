!function(t){var e={};function n(o){if(e[o])return e[o].exports;var i=e[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(o,i,function(e){return t[e]}.bind(null,i));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=21)}([function(t,e){t.exports=require("electron")},function(t,e){t.exports=require("lodash")},function(t,e,n){"use strict";n.d(e,"b",function(){return p}),n.d(e,"c",function(){return f}),n.d(e,"a",function(){return h}),n.d(e,"d",function(){return g}),n.d(e,"g",function(){return m}),n.d(e,"f",function(){return b}),n.d(e,"e",function(){return E});var o=n(1),i=n.n(o);const s=n(3),r=n(5),c=n(7),l=n(15),a=console.log,u=n(8);n(6);let d=[];function p(t){a("CLEAN UP")}function f(t){return d.length||function(){let t=l.get("cfg");a("===setDBs CFG===",t),i.a.compact(t.map(t=>t.active?t.name:null)).forEach((t,e)=>{let n=s.resolve(upath,"pouch",t),o=new u(n);o.dname=t,o.weight=e,d.push(o)})}(),function(t){return Promise.all(d.map(function(e){return e.allDocs({keys:t,include_docs:!0}).then(function(t){if(!t||!t.rows)throw new Error("no dbn result");let n=i.a.compact(t.rows.map(t=>t.doc)),o=i.a.flatten(i.a.compact(n.map(t=>t.docs)));return o.length?(o.forEach(t=>{t.dname=e.dname,t.weight=e.weight}),o):[]}).catch(function(t){console.log("ERR GET DBs",t)})}))}(t)}function h(){let t=l.get("cfg");return t||(t=function(t,e){let n=s.resolve(t,"pouch"),o=r.readdirSync(n),i=[];return o.forEach((t,e)=>{if("cfg.json"==t)return;s.resolve(n,t);let o={name:t,active:!0,idx:e};i.push(o)}),l.set("cfg",i),a("__ZERO CFG__",i),i}(upath)),t}function g(t){let e=s.resolve(t,"pouch","vasilyev"),n=new u(e);n.info().then(function(t){a("LOCAL INFO",t),n.close()});["http://localhost:5984","vasilyev"].join("/")}function m(t,e){}function b(t,e,n){let o=new u(e),i=new u(t);i.replicate.to(o).then(function(t){a("REPLICATION COMPLETED",t),n(!0)}).catch(function(t){a(t),n(!1)})}function E(t){c.get("http://localhost:5984/_all_dbs",{},function(e,n,o){if(e)t("something goes wrong, no connection?");else if(200==n.statusCode)try{let n=JSON.parse(o);t(n)}catch(e){t(e)}else t(n.statusCode)})}},function(t,e){t.exports=require("path")},,function(t,e){t.exports=require("fs-extra")},function(t,e){t.exports=require("electron-is-dev")},function(t,e){t.exports=require("curl")},function(t,e){t.exports=require("pouchdb")},function(t,e){t.exports=require("electron-clipboard-extended")},function(t,e){t.exports=require("slash")},,function(t,e){t.exports=require("split.js")},function(t,e){t.exports=require("cholok")},,function(t,e){t.exports=require("electron-settings")},,function(t,e){t.exports=require("util")},function(t,e){t.exports=require("mousetrap")},function(t,e){t.exports=require("json5")},function(t,e){t.exports=require("axios")},function(t,e,n){"use strict";n.r(e);var o=n(1),i=n.n(o),s=n(0);n(17);function r(t){return document.querySelector(t)}function c(t){return document.querySelectorAll(t)}function l(t,e){let n=document.createElement(t);return e&&n.classList.add(e),n}function a(t,e){let n=document.createElement("span");return n.textContent=t,e&&n.classList.add(e),n}function u(t){if(t)for(;t.hasChildNodes();)t.removeChild(t.lastChild)}function d(t){return t.getBoundingClientRect()}function p(t,e){let n=[t.top,"px"].join(""),o=[t.left,"px"].join("");e.style.top=n,e.style.left=o}var f=n(12),h=n.n(f),g=n(13),m=n.n(g);const b="་",E=["འི","ར","འོ","འམ","འི","ས","འང"];let C=b;const x=console.log;function v(t){if(!t||!t.pars||!t.pars.length)return;let e=t.pars,n=r("#source"),o=r("#result");u(n),u(o),e.forEach(t=>{let e=function(t,e){let n=document.createElement("p");return n.textContent=t,e&&n.classList.add(e),n}();e.classList.add("tibpar"),t.forEach(t=>{let n=a(t.text);t.tib&&n.classList.add("tibphrase"),t.punct&&n.classList.add("punct")," "==t.text&&n.classList.add("space"),e.appendChild(n)}),n.appendChild(e)});c("span.tibetan")}function y(t){let e=d(t),n=m()(t.textContent),o={top:e.top-40,left:e.left+15},i=r("#transcript");i.textContent=n,i.classList.remove("is-hidden"),p(o,i)}function L(t,e){let n;try{n=JSON.parse(t.dataset.chains)}catch(e){return void x("ERR: JSON chains",t)}let o=!t.closest(".tibpar"),i=function(t,e){let n;e?((n=l("div","popup")).classList.add("upper"),document.body.appendChild(n)):n=r("#ambi");let o=d(t);u(n),n.classList.remove("is-hidden"),p({top:o.bottom-3,left:o.left},n);let i=l("ul","ambilist");return n.appendChild(i),i}(t,o);e?function(t,e){e.forEach(e=>{let n,o=l("li","ambiline");t.appendChild(o),e.ambi?(n=a(e.seg,"tibambi")).dataset.chains=JSON.stringify(e.chains):e.docs.length?(n=a(e.seg,"tibwf")).dataset.docs=JSON.stringify(e.docs):n=a(e.seg,"tibphrase"),o.appendChild(n)})}(i,n):function(t,e){t.classList.add("danger"),e.forEach(e=>{let n=l("li","ambiline");t.appendChild(n),e.forEach(t=>{let e=t.docs.length?a(t.seg,"tibwf"):a(t.seg,"tibphrase");t.docs.length&&(e.dataset.docs=JSON.stringify(t.docs)),n.appendChild(e)})})}(i,n),r("#progress").classList.remove("is-shown")}var w=n(2);const O=console.log;const S=s.remote.app,_=(S.getAppPath(),S.getPath("userData")),R=console.log,N=(n(9),n(0).remote.require("electron-settings")),q=n(18),{getCurrentWindow:j}=(n(5),n(3),n(10),n(0).remote);let J,T=[],k=0;function A(t){try{t=JSON.parse(JSON.stringify(t))}catch(e){R("NAV-state ERR",e),t={}}let e=t.section||"home";e||(t.section="home"),function(t){!function(){const t=document.querySelectorAll(".section.is-shown");Array.prototype.forEach.call(t,t=>{t.classList.remove("is-shown")}),r("#transcript").classList.add("is-hidden"),r("#ambi").classList.add("is-hidden")}();const e=["#",t].join("");R("SEC ID",e),r(e).classList.add("is-shown")}(t.section),t.old||(t.old=!1,delete t.old,T.push(t),k=T.length-1);let n=r("#progress");R("BEFORE"),"main"==e?(function(t){let e=N.get("split-sizes")||[50,50];J&&t.mono?J.collapse(1):J&&J.setSizes(e),J||(N.set("split-sizes",e),J=h()(["#source","#result"],{sizes:e,gutterSize:5,cursor:"col-resize",minSize:[0,0],onDragEnd:function(t){N.set("split-sizes",t),j().reload()}}),t.mono&&J.collapse(1),document.addEventListener("keydown",function(t){},!1),document.addEventListener("wheel",function(t){},!1))}(t),v(t)):"clone"==e?function(){O("SERVER DICTS START__________________");let t=["terms","verbs","lobsang","_users"];Object(w.e)(function(e){let n=r("#server-dicts-table tbody"),o=i.a.difference(e,t);O("RDBS=>",e,"dfs",t,"dbns",o),o.forEach(t=>{let e=l("tr");n.appendChild(e);let o=l("td");e.appendChild(o),o.textContent=i.a.capitalize(t);let s=l("td","link");s.textContent="clone",s.dataset.clone=t,e.appendChild(s)})})}():n.classList.remove("is-shown"),N.set("state",t)}q.bind(["alt+left","alt+right"],function(t){37==t.which?function(){if(k<=0)return;k--;let t=T[k];t.old=!0,A(t)}():39==t.which&&function(){if(k>=T.length-1)return;k++;let t=T[k];t.old=!0,A(t)}()}),q.bind(["alt+1","alt+2"],function(t){}),q.bind(["esc"],function(t){}),q.bind(["ctrl+k"],function(t){R("CLICK CLONE"),Object(w.d)(_)}),q.bind(["ctrl+j"],function(t){R("MESS TO BACKG"),s.ipcRenderer.send("replicate","ping")}),q.bind(["ctrl+p"],function(t){R("ZERO CFG"),N.set("cfg","")});console.log;let D={zho:"([一-鿿]+)",tib:"([ༀ-࿿]+)",grc:"([Ͱ-Ͽἀ-῿̀-ͯ']+)"};console.log;const P=b;let z=b;console.log;function K(t,e){r("#progress").classList.add("is-shown");let n,o=t.textContent.trim(),s=new RegExp(z+"$"),c=o.replace(s,""),l=i.a.last(o)==z,u=function(t){let e=t.split(P),n=e.length<10?10:2,o=t,s=(e.length,[[e]]);!function t(e,r){(function(t){let e,n,o=[];for(let i=1;i<t.length+1;i++){e=t.slice(0,i),n=t.slice(i);let s={head:e,tail:n};n.length&&o.push(s)}return o.reverse()})(e).forEach(e=>{r.push(e.head),r.push(e.tail),i.a.flatten(r).join(P)==o&&(s.push(i.a.clone(r)),r.pop()),r.length<n&&t(e.tail,r),r.pop()})}(e,[]);let r=[];return s.forEach(t=>{let e=[];t.forEach(t=>{e.push(t.join(P))}),r.push(e)}),r}(c),d=function(t){let e=i.a.uniq(i.a.flatten(t)),n=[];return e.forEach(t=>{E.forEach(e=>{let o=new RegExp(e+"$"),i=t.replace(o,"");t!=i&&n.push(i)})}),{main:e,added:n}}(u);n=e?i.a.filter(d.main,t=>t!=c):i.a.uniq(d.main.concat(d.added)),Object(w.c)(n).then(n=>{n=i.a.flatten(n);let o,s=function(t,e){let n,o,s=[],r=[];t.forEach(t=>{let n=[],o=!1,c=!0;t.forEach(t=>{let s=i.a.filter(e,e=>(function(t,e){if(t==e)return!0;let n=new RegExp("^"+e),o=t.replace(n,"");return!(t==o||!E.includes(o))})(t,e.dict));s.length&&(o=!0),s.length||(c=!1);let r={seg:t,docs:s};n.push(r)}),o&&s.push(n),c&&r.push(n)}),r.length?(n=F(r),o=!0):n=F(s);return{chains:n,full:o}}(u,n).chains;if(s.length>1)o=function(t){let e,n=t[0],o=[];for(let s=0;s<n.length;s++){let r=t.map(t=>t[s].seg);if(1==i.a.uniq(r).length)o.push(n[s]),e=null;else{e||(e={ambi:!0,seg:"",docs:[]},o.push(e));let n=t.map(t=>({seg:t[s].seg,docs:t[s].docs}));e.docs.push(n)}}return i.a.filter(o,t=>t.ambi).forEach(t=>{let e=t.docs[0],n=[];for(let o=0;o<e.length;o++){let e=t.docs.map(t=>t[o]);n.push(e)}t.chains=n;let o=n[0];t.seg=o.map(t=>t.seg).join(z)}),o}(s);else{if(1!=s.length)return void function(t){x("NO RESULT"),r("#progress").classList.remove("is-shown")}();o=s[0]}e?(t.dataset.chains=JSON.stringify(o),L(t,!0)):function(t,e,n){t.textContent="",e.forEach((n,o)=>{let i;n.ambi?(i=a(n.seg,"tibambi")).dataset.chains=JSON.stringify(n.chains):n.docs.length?(i=a(n.seg,"tibwf")).dataset.docs=JSON.stringify(n.docs):i=a(n.seg,"tibphrase"),t.appendChild(i),o<e.length-1&&t.appendChild(a(C,"tsek"))}),n&&t.appendChild(a(C,"tsek")),r("#progress").classList.remove("is-shown")}(t,o,l)})}function F(t){let e=i.a.max(t.map(t=>i.a.sum(t.map(t=>t.docs.length?t.seg.length:0))/t.length)),n=i.a.filter(t,t=>i.a.sum(t.map(t=>t.docs.length?t.seg.length:0))/t.length>=e-1),o=i.a.min(n.map(t=>t.length));return i.a.filter(n,t=>t.length==o)}const B=n(0).remote.require("electron-settings"),I=(n(19),n(20),n(10),console.log,n(3),n(9)),{dialog:G,getCurrentWindow:M}=n(0).remote;n(6);r("#new-version");let U=r("#container");c('link[rel="import"]').forEach(t=>{let e=t.import.querySelector(".section");U.appendChild(e.cloneNode(!0))}),s.ipcRenderer.on("section",function(t,e){A({section:e})}),s.ipcRenderer.on("action",function(t,e){"clonedicts"==e?A({section:"clone"}):"csv"==e?G.showOpenDialog({properties:["openFile"],filters:[{name:"JSON",extensions:["stardict"]}]},parseCSV):"cleanupdb"==e&&Object(w.b)()}),s.ipcRenderer.on("reread",function(t){let e=B.get("state");M().reload(),A(e)});let V=B.get("state");V||(V={section:"home"}),A(V),document.addEventListener("click",t=>{let e=t.target.dataset;if(e)if(e.external){let e=t.target.textContent;s.shell.openExternal(e)}else e.section?A({section:e.section}):e.clone?function(t){O("CLONING DB",t);let e=r("#cloning-text");e.textContent="...cloning, please wait...";let n=r("#progress");n.classList.add("is-shown"),Object(w.g)(t,function(t){O(t?"OKOK":"FUFU"),e.textContent="",n.classList.remove("is-shown")})}(e.clone):e.docs&&K(t.target,!0)}),document.addEventListener("mouseover",function(t){if(!t.target.textContent)return;if(1==t.ctrlKey)return;t.target.closest(".tibpar")&&c(".popup").forEach(t=>{t.classList.add("is-hidden")}),t.target.classList.contains("tibphrase")?1==t.shiftKey?y(t.target):K(t.target):t.target.classList.contains("tibwf")?function(t){r("#source");let e=r("#result");u(e);let n=t.textContent,o=JSON.parse(t.dataset.docs);try{o=JSON.parse(t.dataset.docs)}catch(t){return void x("ERR: JSON docs")}let i=l("div","dict");e.appendChild(i);let s=l("p","dict-wf");s.textContent=n,i.appendChild(s),o.forEach(t=>{let e=l("p","dict-dname");e.textContent=t.dname,i.appendChild(e);let n=l("p","dict-article");n.textContent=t.dict,i.appendChild(n);let o=l("ul","dict-ul");i.appendChild(o),t.trns||x("NO TRNS",t),t.trns&&t.trns.forEach(t=>{let e=l("li","dict-line");e.textContent=t,o.appendChild(e)})})}(t.target):t.target.classList.contains("tibambi")&&L(t.target)},!1),document.addEventListener("mouseleave",function(t){if(t.target.classList&&1!=t.ctrlKey&&t.target.classList.contains("tibphrase")){r("#transcript").classList.add("is-hidden")}},!1),document.addEventListener("keyup",function(t){if(1==t.ctrlKey)return;r("#transcript").classList.add("is-hidden")},!1),document.addEventListener("keydown",function(t){if(1==t.ctrlKey)return;if(1!=t.shiftKey)return;let e=[].slice.call(document.querySelectorAll(":hover")).pop();"source"==e.id&&(e=r(".tibpar")),y(e)},!1),I.on("text-changed",()=>{let t=((t,e)=>{let n=new RegExp(D[t]);if(!n.test(e))return;let o=e.trim().replace(/᾽/g,"'"),s=o.split("'").join("");if(!n.test(s))return;let r=new RegExp("([.,!:;·།])"),c=o.replace(/\r?\n+/,"\n").split("\n"),l=(c.map(t=>t.split(r)),[]);return c.forEach(e=>{let o=[];e.split(r).forEach(e=>{if(r.test(e)){let t={text:e,punct:!0};o.push(t)}else{let s=e.split(n);(s=i.a.compact(s)).forEach(e=>{let i={text:e};!!n.test(e)&&(i[t]=!0),o.push(i)})}}),l.push(o)}),l})("tib",I.readText());t&&t.length&&A({section:"main",pars:t})}).startWatching(),Object(w.a)()}]);
//# sourceMappingURL=app.js.map