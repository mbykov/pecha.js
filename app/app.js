!function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=22)}([function(t,e){t.exports=require("electron")},function(t,e){t.exports=require("lodash")},function(t,e){t.exports=require("path")},function(t,e,n){"use strict";n.d(e,"f",function(){return f}),n.d(e,"b",function(){return h}),n.d(e,"a",function(){return g}),n.d(e,"c",function(){return m}),n.d(e,"e",function(){return b}),n.d(e,"d",function(){return x});var i=n(1),o=n.n(i);const s=n(2),r=n(6),c=(n(7),n(4)),a=console.log,l=n(8);l.plugin(n(9));const d=n(10),u=new d;new d({host:"couchdb.external.service",protocol:"https",port:6984}),new d({auth:{user:"login",pass:"secret"}});let p=[];function f(t){let e=h(t);a("===setDBs CFG===",e);let n=o.a.compact(e.map(t=>t.active?t.name:null));return a("POUCH:DBNS",n),n.forEach((e,n)=>{let i=s.resolve(t,"pouch",e),o=new l(i);o.dname=e,o.weight=n,p.push(o)}),n}function h(t){let e=c.get("cfg");return e||(e=g(t)),e}function g(t,e){let n=s.resolve(t,"pouch");r.ensureDirSync(n);let i=r.readdirSync(n),o=[];return i.forEach((t,e)=>{s.resolve(n,t);let i={name:t,active:!0,idx:e};o.push(i)}),c.set("cfg",o),o}function m(t){return Promise.all(p.map(function(e){return e.allDocs({keys:t,include_docs:!0}).then(function(t){if(!t||!t.rows)throw new Error("no dbn result");let n=o.a.compact(t.rows.map(t=>t.doc)),i=o.a.flatten(o.a.compact(n.map(t=>t.docs)));return i.length?(i.forEach(t=>{t.dname=e.dname,t.weight=e.weight}),i):[]}).catch(function(t){console.log("ERR GET DBs",t)})}))}function b(t,e){return a("REPLICATE LOCAL",e),new l(e).load("http://localhost:3000/dumps/dump.txt")}function x(){return u.listDatabases().catch(function(t){a("REMOTE DICTS ERR",t)})}},function(t,e){t.exports=require("electron-settings")},,function(t,e){t.exports=require("fs-extra")},function(t,e){t.exports=require("electron-is-dev")},function(t,e){t.exports=require("pouchdb")},function(t,e){t.exports=require("pouchdb-load")},function(t,e){t.exports=require("node-couchdb")},function(t,e){t.exports=require("electron-clipboard-extended")},function(t,e){t.exports=require("slash")},,function(t,e){t.exports=require("split.js")},function(t,e){t.exports=require("cholok")},,function(t,e){t.exports=require("util")},function(t,e){t.exports=require("pouchdb-authentication")},function(t,e){t.exports=require("mousetrap")},function(t,e){t.exports=require("json5")},function(t,e){t.exports=require("axios")},function(t,e,n){"use strict";n.r(e);var i=n(1),o=n.n(i),s=n(0);n(17);function r(t){return document.querySelector(t)}function c(t){return document.querySelectorAll(t)}function a(t,e){let n=document.createElement(t);return e&&n.classList.add(e),n}function l(t,e){let n=document.createElement("span");return n.textContent=t,e&&n.classList.add(e),n}function d(t){if(t)for(;t.hasChildNodes();)t.removeChild(t.lastChild)}function u(t){return t.getBoundingClientRect()}function p(t,e){let n=[t.top,"px"].join(""),i=[t.left,"px"].join("");e.style.top=n,e.style.left=i}function f(){return[].slice.call(document.querySelectorAll(":hover")).pop()}var h=n(14),g=n.n(h),m=n(15),b=n.n(m);const x="་",C=["འི","ར","འོ","འམ","འི","ས","འང"];let v=x;const E=console.log;function y(t){if(!t||!t.pars||!t.pars.length)return;let e=t.pars,n=r("#source"),i=r("#result");d(n),d(i),e.forEach(t=>{let e=function(t,e){let n=document.createElement("p");return n.textContent=t,e&&n.classList.add(e),n}();e.classList.add("tibpar"),t.forEach(t=>{let n=l(t.text);t.tib&&n.classList.add("tibphrase"),t.punct&&n.classList.add("punct")," "==t.text&&n.classList.add("space"),e.appendChild(n)}),n.appendChild(e)});c("span.tibetan")}function w(t){let e=u(t),n=b()(t.textContent),i={top:e.top-40,left:e.left+15},o=r("#transcript");o.textContent=n,o.classList.remove("is-hidden"),p(i,o)}function L(t,e){let n;try{n=JSON.parse(t.dataset.chains)}catch(e){return void E("ERR: JSON chains",t)}let i=!t.closest(".tibpar"),o=function(t,e){let n;e?((n=a("div","popup")).classList.add("upper"),document.body.appendChild(n)):n=r("#ambi");let i=u(t);d(n),n.classList.remove("is-hidden"),p({top:i.bottom-3,left:i.left},n);let o=a("ul","ambilist");return n.appendChild(o),o}(t,i);e?function(t,e){e.forEach(e=>{let n,i=a("li","ambiline");t.appendChild(i),e.ambi?(n=l(e.seg,"tibambi")).dataset.chains=JSON.stringify(e.chains):e.docs.length?(n=l(e.seg,"tibwf")).dataset.docs=JSON.stringify(e.docs):n=l(e.seg,"tibphrase"),i.appendChild(n)})}(o,n):function(t,e){t.classList.add("danger"),e.forEach(e=>{let n=a("li","ambiline");t.appendChild(n),e.forEach(t=>{let e=t.docs.length?l(t.seg,"tibwf"):l(t.seg,"tibphrase");t.docs.length&&(e.dataset.docs=JSON.stringify(t.docs)),n.appendChild(e)})})}(o,n),r("#progress").classList.remove("is-shown")}console.log;const S=n(4);function R(){let t=S.get("cfg"),e=(t.map(t=>t.name),r("#local-dicts-table tbody"));d(e),t.forEach(t=>{let n=t.name,i=a("tr");e.appendChild(i);let s=a("td","dictname");i.appendChild(s),s.textContent=o.a.capitalize(n),s.dataset.firstdict=n;let r=a("td","active-dict");if(t.active){let t=O();r.appendChild(t)}else r.textContent="activate";r.dataset.activedict=n,i.appendChild(r)})}function q(t){let e=S.get("cfg"),n=o.a.find(e,e=>e.name==t.dataset.activedict),i=O();t.textContent?(t.textContent="",t.appendChild(i),n.active=!0):(d(t),t.textContent="activate",n.active=!1),S.set("cfg",e)}function O(){let t=a("img","dict-check");return t.setAttribute("src","../resources/check.png"),t}s.ipcRenderer.on("remoteDictsReply",function(t,e){!function(t){S.get("upath");let e=S.get("cfg"),n=["_users"],i=e.map(t=>t.name),s=o.a.uniq(n.concat(i)),c=r("#server-dicts-table tbody");d(c),t.forEach(t=>{if(n.includes(t))return;let e=a("tr");c.appendChild(e);let i=a("td");e.appendChild(i),i.textContent=o.a.capitalize(t);let r=a("td","link");if(s.includes(t)){let t=O();r.appendChild(t)}else r.textContent="sync";r.dataset.clone=t,e.appendChild(r)})}(e)}),s.ipcRenderer.on("replicateReply",function(t,e){U({section:"activedicts"})});const N=n(2),j=(n(4),console.log),k=n(8);k.plugin(n(18));var D=n(3);const J=s.remote.app,P=(J.getAppPath(),J.getPath("userData")),z=console.log,A=(n(11),n(0).remote.require("electron-settings")),T=n(19),{getCurrentWindow:_}=(n(6),n(2),n(12),n(0).remote);let K,B=[],I=0;function U(t){try{t=JSON.parse(JSON.stringify(t))}catch(e){z("NAV-state ERR",e),t={}}let e=t.section||"home";e||(t.section="home"),function(t){(function(){const t=document.querySelectorAll(".section.is-shown");Array.prototype.forEach.call(t,t=>{t.classList.remove("is-shown")}),r("#transcript").classList.add("is-hidden"),r("#ambi").classList.add("is-hidden")})(),r(["#",t].join("")).classList.add("is-shown")}(t.section),t.old||(t.old=!1,delete t.old,B.push(t),I=B.length-1);let n=r("#progress");"main"==e?(function(t){let e=A.get("split-sizes")||[50,50];K&&t.mono?K.collapse(1):K&&K.setSizes(e),K||(A.set("split-sizes",e),K=g()(["#source","#result"],{sizes:e,gutterSize:5,cursor:"col-resize",minSize:[0,0],onDragEnd:function(t){A.set("split-sizes",t),_().reload()}}),t.mono&&K.collapse(1),document.addEventListener("keydown",function(t){},!1),document.addEventListener("wheel",function(t){},!1))}(t),y(t)):"clone"==e?s.ipcRenderer.send("remoteDicts",""):"activedicts"==e?R():n.classList.remove("is-shown"),A.set("state",t)}T.bind(["alt+left","alt+right"],function(t){37==t.which?function(){if(I<=0)return;I--;let t=B[I];t.old=!0,U(t)}():39==t.which&&function(){if(I>=B.length-1)return;I++;let t=B[I];t.old=!0,U(t)}()}),T.bind(["alt+1","alt+2"],function(t){}),T.bind(["esc"],function(t){}),T.bind(["ctrl+i"],function(t){z("CLICK INFO")}),T.bind(["ctrl+u"],function(t){z("CLICK SIGNUP"),function(t){let e=new k("http://localhost:5984/mydb",{skip_setup:!0}),n=N.resolve(t,"pouch","auth");new k(n).sync(e,{live:!0,retry:!0}).on("error",console.log.bind(console)),e.signUp("batman","brucewayne",function(t,e){t&&("conflict"===t.name||t.name)}).then(function(t){j("SIGNUP RES",t)})}(P)}),T.bind(["ctrl+p"],function(t){z("ZERO CFG"),Object(D.a)(P)});console.log;let G={zho:"([一-鿿]+)",tib:"([ༀ-࿿]+)",grc:"([Ͱ-Ͽἀ-῿̀-ͯ']+)"};console.log;const M=x;let F=x;console.log;function W(t,e){r("#progress").classList.add("is-shown");let n,i=t.textContent.trim(),c=new RegExp(F+"$"),a=i.replace(c,""),l=o.a.last(i)==F,d=function(t){let e=t.split(M),n=e.length<10?10:2,i=t,s=(e.length,[[e]]);!function t(e,r){(function(t){let e,n,i=[];for(let o=1;o<t.length+1;o++){e=t.slice(0,o),n=t.slice(o);let s={head:e,tail:n};n.length&&i.push(s)}return i.reverse()})(e).forEach(e=>{r.push(e.head),r.push(e.tail),o.a.flatten(r).join(M)==i&&(s.push(o.a.clone(r)),r.pop()),r.length<n&&t(e.tail,r),r.pop()})}(e,[]);let r=[];return s.forEach(t=>{let e=[];t.forEach(t=>{e.push(t.join(M))}),r.push(e)}),r}(a),u=function(t){let e=o.a.uniq(o.a.flatten(t)),n=[];return e.forEach(t=>{C.forEach(e=>{let i=new RegExp(e+"$"),o=t.replace(i,"");t!=o&&n.push(o)})}),{main:e,added:n}}(d),p={keys:n=e?o.a.filter(u.main,t=>t!=a):o.a.uniq(u.main.concat(u.added)),pdchs:d,compound:e,lastsek:l};s.ipcRenderer.send("queryDBs",p)}function V(t){let e=o.a.max(t.map(t=>o.a.sum(t.map(t=>t.docs.length?t.seg.length:0))/t.length)),n=o.a.filter(t,t=>o.a.sum(t.map(t=>t.docs.length?t.seg.length:0))/t.length>=e-1),i=o.a.min(n.map(t=>t.length));return o.a.filter(n,t=>t.length==i)}s.ipcRenderer.on("replayDBs",function(t,e){!function(t){let e,n=f(),i=o.a.flatten(t.docs),s=function(t,e){let n,i,s=[],r=[];t.forEach(t=>{let n=[],i=!1,c=!0;t.forEach(t=>{let s=o.a.filter(e,e=>(function(t,e){if(t==e)return!0;let n=new RegExp("^"+e),i=t.replace(n,"");return!(t==i||!C.includes(i))})(t,e.dict));s.length&&(i=!0),s.length||(c=!1);let r={seg:t,docs:s};n.push(r)}),i&&s.push(n),c&&r.push(n)}),r.length?(n=V(r),i=!0):n=V(s);return{chains:n,full:i}}(t.pdchs,i).chains;if(s.length>1)e=function(t){let e,n=t[0],i=[];for(let s=0;s<n.length;s++){let r=t.map(t=>t[s].seg);if(1==o.a.uniq(r).length)i.push(n[s]),e=null;else{e||(e={ambi:!0,seg:"",docs:[]},i.push(e));let n=t.map(t=>({seg:t[s].seg,docs:t[s].docs}));e.docs.push(n)}}return o.a.filter(i,t=>t.ambi).forEach(t=>{let e=t.docs[0],n=[];for(let i=0;i<e.length;i++){let e=t.docs.map(t=>t[i]);n.push(e)}t.chains=n;let i=n[0];t.seg=i.map(t=>t.seg).join(F)}),i}(s);else{if(1!=s.length)return E("NO RESULT"),void r("#progress").classList.remove("is-shown");e=s[0]}t.compound?(n.dataset.chains=JSON.stringify(e),L(n,!0)):function(t,e,n){t.textContent="",e.forEach((n,i)=>{let o;n.ambi?(o=l(n.seg,"tibambi")).dataset.chains=JSON.stringify(n.chains):n.docs.length?(o=l(n.seg,"tibwf")).dataset.docs=JSON.stringify(n.docs):o=l(n.seg,"tibphrase"),t.appendChild(o),i<e.length-1&&t.appendChild(l(v,"tsek"))}),n&&t.appendChild(l(v,"tsek")),r("#progress").classList.remove("is-shown")}(n,e,t.lastsek)}(e)});const $=n(0).remote.require("electron-settings"),H=(n(20),n(21),n(12),console.log),Z=(n(2),n(11)),{dialog:Q,getCurrentWindow:X}=n(0).remote;n(7);r("#new-version");let Y=r("#container");c('link[rel="import"]').forEach(t=>{let e=t.import.querySelector(".section");Y.appendChild(e.cloneNode(!0))}),s.ipcRenderer.on("section",function(t,e){U({section:e})}),s.ipcRenderer.on("action",function(t,e){"clonedicts"==e?U({section:"clone"}):"arrangeDicts"==e?U({section:"activedicts"}):"csv"==e?Q.showOpenDialog({properties:["openFile"],filters:[{name:"JSON",extensions:["stardict"]}]},parseCSV):"cleanupdb"==e&&U({section:"clone"})}),s.ipcRenderer.on("reread",function(t){let e=$.get("state");X().reload(),U(e)});let tt=$.get("state");tt||(tt={section:"home"}),U(tt),document.addEventListener("click",t=>{let e=t.target.dataset;if(!e)return;let n=t.target.parentElement;if(e.external){let e=t.target.textContent;s.shell.openExternal(e)}else e.section?U({section:e.section}):e.clone?s.ipcRenderer.send("replicate",e.clone):e.firstdict?function(t){let e=S.get("cfg"),n=o.a.find(e,e=>e.name==t),i=o.a.reject(e,e=>e.name==t);i.unshift(n),(e=i).forEach((t,e)=>{t.idx=e}),S.set("cfg",e),R()}(e.firstdict):e.activedict?q(t.target):n.dataset.activedict?q(n):"cleanupdb"==t.target.id?H("CLEAN UP DBs!"):e.docs&&W(t.target,!0)}),document.addEventListener("mouseover",function(t){if(!t.target.textContent)return;if(1==t.ctrlKey)return;t.target.closest(".tibpar")&&c(".popup").forEach(t=>{t.classList.add("is-hidden")}),t.target.classList.contains("tibphrase")?1==t.shiftKey?w(t.target):W(t.target):t.target.classList.contains("tibwf")?function(t){r("#source");let e=r("#result");d(e);let n=t.textContent,i=JSON.parse(t.dataset.docs);try{i=JSON.parse(t.dataset.docs)}catch(t){return void E("ERR: JSON docs")}let o=a("div","dict");e.appendChild(o);let s=a("p","dict-wf");s.textContent=n,o.appendChild(s),i.forEach(t=>{let e=a("p","dict-dname");e.textContent=t.dname,o.appendChild(e);let n=a("p","dict-article");n.textContent=t.dict,o.appendChild(n);let i=a("ul","dict-ul");o.appendChild(i),t.trns||E("NO TRNS",t),t.trns&&t.trns.forEach(t=>{let e=a("li","dict-line");e.textContent=t,i.appendChild(e)})})}(t.target):t.target.classList.contains("tibambi")&&L(t.target)},!1),document.addEventListener("mouseleave",function(t){if(t.target.classList&&1!=t.ctrlKey&&t.target.classList.contains("tibphrase")){r("#transcript").classList.add("is-hidden")}},!1),document.addEventListener("keyup",function(t){if(1==t.ctrlKey)return;r("#transcript").classList.add("is-hidden")},!1),document.addEventListener("keydown",function(t){if(1==t.ctrlKey)return;if(1!=t.shiftKey)return;let e=f();"source"==e.id&&(e=r(".tibpar")),w(e)},!1),Z.on("text-changed",()=>{let t=((t,e)=>{let n=new RegExp(G[t]);if(!n.test(e))return;let i=e.trim().replace(/᾽/g,"'"),s=i.split("'").join("");if(!n.test(s))return;let r=new RegExp("([.,!:;·།])"),c=i.replace(/\r?\n+/,"\n").split("\n"),a=(c.map(t=>t.split(r)),[]);return c.forEach(e=>{let i=[];e.split(r).forEach(e=>{if(r.test(e)){let t={text:e,punct:!0};i.push(t)}else{let s=e.split(n);(s=o.a.compact(s)).forEach(e=>{let o={text:e};!!n.test(e)&&(o[t]=!0),i.push(o)})}}),a.push(i)}),a})("tib",Z.readText());t&&t.length&&U({section:"main",pars:t})}).startWatching()}]);
//# sourceMappingURL=app.js.map