!function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=29)}([function(t,e){t.exports=require("lodash")},function(t,e){t.exports=require("electron")},function(t,e,n){"use strict";n.d(e,"b",function(){return i}),n.d(e,"a",function(){return o});const i={tsek:"་"},o=["འི","ར","འོ","འམ","འི","ས","འང"]},function(t,e,n){"use strict";var i=n(0),o=n.n(i),r=n(5),s=n.n(r),c=n(2);console.log;const a=c.b.tsek;n.d(e,"d",function(){return L}),n.d(e,"e",function(){return S}),n.d(e,"a",function(){return q}),n.d(e,"c",function(){return R}),n.d(e,"b",function(){return O});const l=c.b.tsek;let u=new RegExp(l+"$"),d=n(13);n(7)("app");const p=n(4),f=n(9);let h=n(14)({gitignore:!0});n(10);const g=n(6),m=console.log,b=n(11);b.plugin(n(15));let v=[],E="tib",x=[],y=/༈/;const C=n(16),w=new C;new C({host:"couchdb.external.service",protocol:"https",port:6984}),new C({auth:{user:"login",pass:"secret"}});function L(){return w.listDatabases().catch(function(t){m("REMOTE DICTS ERR",t)})}function S(t,e){m("REPLICATE LOCAL",e);let n=new b(e);return n.info().then(function(e){return m("REPL-BEFORE-INFO",e),n.load(t)})}function q(){let t=g.get("upath"),e=p.resolve(t,"pouch"),n=f.readdirSync(e),i=g.get("cfg")||[],r=[];return n.forEach((t,e)=>{let n=o.a.find(i,e=>e.name==t);if(n)r.push(n);else{let n={name:t,active:!0,idx:100+e};r.push(n)}}),(r=o.a.sortBy(r,"idx")).forEach((t,e)=>{t.idx=e}),g.set("cfg",r),function(t,e){x=[];let n=o.a.compact(e.map(t=>t.active?t.name:null));m("setDBNS",n),n.forEach((e,n)=>{let i=p.resolve(t,"pouch",e),o=new b(i);o.dname=e,o.weight=n,x.push(o)})}(t,r),r}function R(t){m("QUERY->",t.str);t.str.replace(y,"");let e,n=function(t){let e=t.split(a),n=4,i=t,r=(e.length,[[e]]);!function t(e,s){(function(t){let e,n,i=[];for(let o=1;o<t.length+1;o++){e=t.slice(0,o),n=t.slice(o);let r={head:e,tail:n};n.length&&i.push(r)}return i.reverse()})(e).forEach(e=>{s.push(e.head),s.push(e.tail),o.a.flatten(s).join(a)==i&&(r.push(o.a.clone(s)),s.pop()),s.length<n&&t(e.tail,s),s.pop()})}(e,[]);let s=[];return r.forEach(t=>{let e=[];t.forEach(t=>{e.push(t.join(a))}),s.push(e)}),s}(t.str),i=function(t){let e=o.a.uniq(o.a.flatten(t)),n=[];return e.forEach(t=>{c.a.forEach(e=>{let i=new RegExp(e+"$"),o=t.replace(i,"");t!=o&&n.push(o)})}),{main:e,added:n}}(n);return e=t.compound?o.a.filter(i.main,e=>e!=t.str):o.a.uniq(i.main.concat(i.added)),Promise.all(x.map(function(t){return t.allDocs({keys:e,include_docs:!0}).then(function(e){if(!e||!e.rows)throw new Error("no dbn result");let n=o.a.compact(e.rows.map(t=>t.doc)),i=o.a.flatten(o.a.compact(n.map(t=>t.docs)));return i.forEach(e=>{e.dname=t.dname,e.weight=t.weight}),i}).catch(function(t){console.log("ERR GET DBs",t)})})).then(function(e){let i=function(t,e){let n,i=function(t,e){let n,i,r=[],s=[];t.forEach(t=>{let n=[],i=!1,a=!0;t.forEach(t=>{let r=o.a.filter(e,e=>(function(t,e){if(t==e)return!0;let n=new RegExp("^"+e),i=t.replace(n,"");return!(t==i||!c.a.includes(i))})(t,e.dict));r.length&&(i=!0),r.length||(a=!1);let s={seg:t,docs:r};n.push(s)}),i&&r.push(n),a&&s.push(n)}),s.length?(n=N(s),i=!0):n=N(r);return{chains:n,full:i}}(e,t).chains;i.length>1?n=function(t){let e,n=t[0],i=[];for(let r=0;r<n.length;r++){let s=t.map(t=>t[r].seg);if(1==o.a.uniq(s).length)i.push(n[r]),e=null;else{e||(e={ambi:!0,seg:"",docs:[]},i.push(e));let n=t.map(t=>({seg:t[r].seg,docs:t[r].docs}));e.docs.push(n)}}return o.a.filter(i,t=>t.ambi).forEach(t=>{let e=t.docs[0],n=[];for(let i=0;i<e.length;i++){let e=t.docs.map(t=>t[i]);n.push(e)}t.chains=n;let i=n[0];t.seg=i.map(t=>t.seg).join(l)}),i}(i):1==i.length&&(n=i[0]);return n}(o.a.flatten(e),n);return v.push(i),t.chain=i,t})}function O(t){m("LOCAL",t),t=p.resolve(__dirname,t);let e=h.readdirSync("**/*.tib*",{cwd:t}),n=function(t,e){let n=[],i={};return e.forEach(e=>{let r=p.resolve(t,e),c=f.readFileSync(r,"utf8").trim().split("\n");(c=o.a.compact(c)).forEach((t,e)=>{let o=function(t){let e=t.trim();return e=e.trim().replace(/\.$/,"")}(t);s()(o,E).forEach(t=>{t.forEach(t=>{t.lang==E&&t.text.split(" ").forEach(t=>{t=t.replace(u,""),i[t]||(n.push(t),i[t]=!0)})})})})}),n}(t,e=o.a.uniq(e));m("QS",n.length,o.a.uniq(n).length);let i=n.map(t=>({str:t}));d(i).parallel(5).map(R).toArray(function(t){let e=[],n=[];Promise.all(t).then(function(t){o.a.flatten(t.map(t=>t.chain)).forEach(t=>{t.docs.length?n.push(t.seg):e.push(t.seg)}),m("dicts:",n),m("empties:",e);let i=e.map(t=>({str:t}));e=[],d(i).map(R).toArray(function(t){m("qpromises",t),Promise.all(t).then(function(t){let i=o.a.flatten(t.map(t=>t.chain));m("CH",i),i.forEach(t=>{t.docs.length?n.push(t.seg):e.push(t.seg)}),m("DICTS",n.length),m("EMPTIES",e)})})})})}function N(t){let e=o.a.max(t.map(t=>o.a.sum(t.map(t=>t.docs.length?t.seg.length:0))/t.length)),n=o.a.filter(t,t=>o.a.sum(t.map(t=>t.docs.length?t.seg.length:0))/t.length>=e-1),i=o.a.min(n.map(t=>t.length));return o.a.filter(n,t=>t.length==i)}},function(t,e){t.exports=require("path")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i;(i=n(12))&&i.__esModule;var o=n(0),r=(console.log,n(7)("app"),{zho:"([一-鿿]+)",tib:"([ༀ-࿿]+)",grc:"([Ͱ-Ͽἀ-῿̀-ͯ' ]+)"});e.default=function(t,e){var n=new RegExp(r[e]);if(n.test(t)){var i=t.trim().replace(/᾽/g,"'"),s=i.split("'").join("");if(n.test(s)){var c=new RegExp("([.,!:;·།])"),a=i.replace(/\r?\n+/,"\n").split("\n"),l=(a.map(function(t){return t.split(c)}),[]);return a.forEach(function(t){var i=[];t.split(c).forEach(function(t){if(c.test(t)){var r={text:t,punct:!0};i.push(r)}else{var s=t.split(n);(s=o.compact(s)).forEach(function(t){if(t=t.trim()){var o={text:t};!!n.test(t)&&(o.lang=e),i.push(o)}})}}),l.push(i)}),l}}}},function(t,e){t.exports=require("electron-settings")},function(t,e){t.exports=require("debug")},,function(t,e){t.exports=require("fs-extra")},function(t,e){t.exports=require("electron-is-dev")},function(t,e){t.exports=require("pouchdb")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;e.default=function(){return"new message"}},function(t,e){t.exports=require("highland")},function(t,e){t.exports=require("glob-fs")},function(t,e){t.exports=require("pouchdb-load")},function(t,e){t.exports=require("node-couchdb")},function(t,e){t.exports=require("cholok")},function(t,e){t.exports=require("electron-clipboard-extended")},function(t,e){t.exports=require("slash")},,function(t,e){t.exports=require("split.js")},,function(t,e){t.exports=require("util")},function(t,e){t.exports=require("pouchdb-authentication")},function(t,e){t.exports=require("mousetrap")},function(t,e){t.exports=require("json5")},function(t,e){t.exports=require("axios")},,function(t,e,n){"use strict";n.r(e);var i=n(0),o=n.n(i),r=n(1);n(23);function s(t){return document.querySelector(t)}function c(t){return document.querySelectorAll(t)}function a(t,e){let n=document.createElement(t);return e&&n.classList.add(e),n}function l(t,e){let n=document.createElement("span");return n.textContent=t,e&&n.classList.add(e),n}function u(t){if(t)for(;t.hasChildNodes();)t.removeChild(t.lastChild)}function d(t){return t.getBoundingClientRect()}function p(t,e){let n=[t.top,"px"].join(""),i=[t.left,"px"].join("");e.style.top=n,e.style.left=i}function f(){return[].slice.call(document.querySelectorAll(":hover")).pop()}var h=n(21),g=n.n(h),m=n(17),b=n.n(m),v=n(2);const E=n(1).remote.require("electron-settings");let x=v.b.tsek;const y=console.log;function C(t){let e=t.pars,n=s("#source"),i=s("#result");u(n),u(i),e.forEach(t=>{let e=function(t,e){let n=document.createElement("p");return n.textContent=t,e&&n.classList.add(e),n}();e.classList.add("tibpar"),t.forEach(t=>{let n=l(t.text);t.lang?n.classList.add("tibphrase"):t.punct?n.classList.add("punct"):n.classList.add("space"),e.appendChild(n)}),n.appendChild(e)});c("span.tibetan")}function w(t,e){let n=d(t),i=e?b()(t.textContent,!0):b()(t.textContent),o={top:n.top-40,left:n.left+15},r=s("#transcript");r.textContent=i,r.classList.remove("is-hidden"),p(o,r)}function L(t,e){let n;try{n=JSON.parse(t.dataset.chains)}catch(e){return void y("ERR: JSON chains",t)}let i=!t.closest(".tibpar"),o=function(t,e){let n;e?((n=a("div","popup")).classList.add("upper"),document.body.appendChild(n)):n=s("#ambi");let i=d(t);u(n),n.classList.remove("is-hidden"),p({top:i.bottom-3,left:i.left},n);let o=a("ul","ambilist");return n.appendChild(o),o}(t,i);e?function(t,e){e.forEach(e=>{let n,i=a("li","ambiline");t.appendChild(i),e.ambi?(n=l(e.seg,"tibambi")).dataset.chains=JSON.stringify(e.chains):e.docs.length?(n=l(e.seg,"tibwf")).dataset.docs=JSON.stringify(e.docs):n=l(e.seg,"tibphrase"),i.appendChild(n)})}(o,n):function(t,e){t.classList.add("danger"),e.forEach(e=>{let n=a("li","ambiline");t.appendChild(n),e.forEach(t=>{let e=t.docs.length?l(t.seg,"tibwf"):l(t.seg,"tibphrase");t.docs.length&&(e.dataset.docs=JSON.stringify(t.docs)),n.appendChild(e)})})}(o,n),s("#progress").classList.remove("is-shown")}function S(t,e){s("#progress").classList.add("is-shown");let n=t.textContent.trim(),i=new RegExp(x+"$"),c={str:n.replace(i,""),compound:e,lastsek:o.a.last(n)==x};r.ipcRenderer.send("queryDBs",c)}r.ipcRenderer.on("replayDBs",function(t,e){let n=e.chain,i=f();n?e.compound?(i.dataset.chains=JSON.stringify(n),L(i,!0)):function(t,e,n){t.textContent="",e.forEach((n,i)=>{let o;n.ambi?(o=l(n.seg,"tibambi")).dataset.chains=JSON.stringify(n.chains):n.docs.length?(o=l(n.seg,"tibwf")).dataset.docs=JSON.stringify(n.docs):o=l(n.seg,"tibphrase"),t.appendChild(o),i<e.length-1&&t.appendChild(l(x,"tsek"))}),n&&t.appendChild(l(x,"tsek")),s("#progress").classList.remove("is-shown")}(i,n,e.lastsek):s("#progress").classList.remove("is-shown")});var q=n(3);console.log;const R=n(6);function O(){let t=R.get("cfg"),e=(t.map(t=>t.name),s("#local-dicts-table tbody"));u(e),t.forEach(t=>{let n=t.name,i=a("tr");e.appendChild(i);let r=a("td","dictname");i.appendChild(r),r.textContent=o.a.capitalize(n),r.dataset.firstdict=n;let s=a("td","active-dict");if(t.active){let t=j();s.appendChild(t)}else s.textContent="activate";s.dataset.activedict=n,i.appendChild(s)})}function N(t){let e=R.get("cfg"),n=o.a.find(e,e=>e.name==t.dataset.activedict),i=j();t.textContent?(t.textContent="",t.appendChild(i),n.active=!0):(u(t),t.textContent="activate",n.active=!1),R.set("cfg",e)}function j(){let t=a("img","dict-check");return t.setAttribute("src","../resources/check.png"),t}r.ipcRenderer.on("remoteDictsReply",function(t,e){!function(t){let e=R.get("cfg"),n=["_users"],i=e.map(t=>t.name),r=o.a.uniq(n.concat(i)),c=s("#server-dicts-table tbody");u(c),t.forEach(t=>{if(n.includes(t))return;let e=a("tr");c.appendChild(e);let i=a("td");e.appendChild(i),i.textContent=o.a.capitalize(t);let s=a("td","link");if(r.includes(t)){let t=j();s.appendChild(t)}else s.textContent="sync";s.dataset.clone=t,e.appendChild(s)})}(e)}),r.ipcRenderer.on("replicateOK",function(t,e){F({section:"activedicts"})});const k=n(4),P=(n(6),console.log),_=n(11);_.plugin(n(24));const D=r.remote.app,J=(D.getAppPath(),D.getPath("userData")),A=console.log,T=(n(18),n(1).remote.require("electron-settings")),z=n(25),{getCurrentWindow:B}=(n(9),n(4),n(19),n(1).remote);let K,M=[],I=0;function U(){const t=document.querySelectorAll(".section.is-shown");Array.prototype.forEach.call(t,t=>{t.classList.remove("is-shown")}),s("#transcript").classList.add("is-hidden"),s("#ambi").classList.add("is-hidden")}function F(t){try{t=JSON.parse(JSON.stringify(t))}catch(e){A("NAV-state ERR",e),t={}}let e=t.section||"home";e||(t.section="home"),function(t){U(),s(["#",t].join("")).classList.add("is-shown")}(t.section),t.old||(t.old=!1,delete t.old,M.push(t),I=M.length-1);let n=s("#progress");"main"==e?(function(t){let e=T.get("split-sizes")||[50,50];K&&t.mono?K.collapse(1):K&&K.setSizes(e),K||(T.set("split-sizes",e),K=g()(["#source","#result"],{sizes:e,gutterSize:5,cursor:"col-resize",minSize:[0,0],onDragEnd:function(t){T.set("split-sizes",t),B().reload()}}),t.mono&&K.collapse(1),document.addEventListener("keydown",function(t){},!1),document.addEventListener("wheel",function(t){},!1))}(t),C(t)):"clonedicts"==e?r.ipcRenderer.send("remoteDicts",""):"activedicts"==e?O():n.classList.remove("is-shown"),T.set("state",t)}z.bind(["alt+left","alt+right"],function(t){37==t.which?function(){if(I<=0)return;I--;let t=M[I];t.old=!0,U(),F(t)}():39==t.which&&function(){if(I>=M.length-1)return;I++;let t=M[I];t.old=!0,U(),F(t)}()}),z.bind(["alt+1","alt+2"],function(t){}),z.bind(["esc"],function(t){}),z.bind(["ctrl+d"],function(t){r.ipcRenderer.send("queryLocalDict","/home/michael/diglossa.texts/Tibetan")}),z.bind(["ctrl+u"],function(t){A("CLICK SIGNUP"),function(t){let e=new _("http://localhost:5984/mydb",{skip_setup:!0}),n=k.resolve(t,"pouch","auth");new _(n).sync(e,{live:!0,retry:!0}).on("error",console.log.bind(console)),e.signUp("batman","brucewayne",function(t,e){t&&("conflict"===t.name||t.name)}).then(function(t){P("SIGNUP RES",t)})}(J)});var $=n(5),G=n.n($);n.d(e,"scrollPane",function(){return tt});const W=n(1).remote.require("electron-settings"),Q=(n(26),n(27),n(19),console.log),V=(n(4),n(18)),{dialog:Y,getCurrentWindow:H}=n(1).remote;n(10);s("#new-version");let X=s("#container");c('link[rel="import"]').forEach(t=>{let e=t.import.querySelector(".section");X.appendChild(e.cloneNode(!0))}),r.ipcRenderer.on("section",function(t,e){F({section:e})}),r.ipcRenderer.on("action",function(t,e){"clonedicts"==e?F({section:"clone"}):"arrangeDicts"==e?F({section:"activedicts"}):"csv"==e?Y.showOpenDialog({properties:["openFile"],filters:[{name:"JSON",extensions:["stardict"]}]},parseCSV):"cleanupdb"==e&&F({section:"clone"})}),r.ipcRenderer.on("reread",function(t){let e=W.get("state");H().reload(),F(e)});let Z=W.get("state");function tt(t,e){if(1==t.shiftKey)return;let n=t.deltaY>0?24:-24;s(".section.is-shown").scrollTop+=n}Z||(Z={section:"home"}),F(Z),document.addEventListener("click",t=>{let e=t.target.dataset;if(!e)return;let n=t.target.parentElement;if(t.target.classList.contains("external")){let e=t.target.textContent;r.shell.openExternal(e)}else e.section?F({section:e.section}):e.clone?r.ipcRenderer.send("replicate",e.clone):e.firstdict?function(t){let e=R.get("cfg"),n=o.a.find(e,e=>e.name==t),i=o.a.reject(e,e=>e.name==t);i.unshift(n),(e=i).forEach((t,e)=>{t.idx=e}),R.set("cfg",e),Object(q.a)(),O()}(e.firstdict):e.activedict?N(t.target):n&&n.dataset&&n.dataset.activedict?N(n):"cleanupdb"==t.target.id?Q("CLEAN UP DBs!"):e.docs&&S(t.target,!0)}),document.addEventListener("mouseover",function(t){if(!t.target.textContent)return;if(1==t.ctrlKey)return;t.target.closest(".tibpar")&&c(".popup").forEach(t=>{t.classList.add("is-hidden")}),t.target.classList.contains("tibphrase")?1==t.shiftKey||S(t.target):t.target.classList.contains("tibwf")?function(t){s("#source");let e=s("#result");u(e);let n=t.textContent,i=JSON.parse(t.dataset.docs);try{i=JSON.parse(t.dataset.docs)}catch(t){return void y("ERR: JSON docs")}let r=E.get("cfg");JSON.parse(JSON.stringify(r)),i.forEach(t=>{t.weight=o.a.find(r,e=>t.dname==e.name).idx}),i=o.a.sortBy(i,"weight");let c=a("div","dict");e.appendChild(c);let l=a("p","dict-wf");l.textContent=n,c.appendChild(l),i.forEach(t=>{let e=a("p","dict-dname");e.textContent=t.dname,c.appendChild(e);let n=a("p","dict-article");n.textContent=t.dict,c.appendChild(n);let i=a("ul","dict-ul");c.appendChild(i),t.trns||y("NO TRNS",t),t.trns&&t.trns.forEach(t=>{let e=a("li","dict-line");e.textContent=t,i.appendChild(e)})})}(t.target):t.target.classList.contains("tibambi")&&L(t.target)},!1),document.addEventListener("mouseleave",function(t){if(t.target.classList&&1!=t.ctrlKey&&t.target.classList.contains("tibphrase")){s("#transcript").classList.add("is-hidden")}},!1),document.addEventListener("keyup",function(t){if(1==t.ctrlKey)return;s("#transcript").classList.add("is-hidden")},!1),document.addEventListener("keydown",function(t){if(1!=t.shiftKey)return;let e=f();"source"==e.id&&(e=s(".tibpar")),w(e),1==t.ctrlKey&&w(e,!0)},!1),document.addEventListener("wheel",function(t){tt(t,Z)},!1),V.on("text-changed",()=>{let t=V.readText(),e=G()(t,"tib");e&&e.length&&F({section:"main",pars:e})}).startWatching()}]);
//# sourceMappingURL=app.js.map